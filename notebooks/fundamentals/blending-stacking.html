
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blending and Stacking &#8212; 𝗜𝗻𝗲𝗳𝗳𝗶𝗰𝗶𝗲𝗻𝘁 𝗡𝗲𝘁𝘄𝗼𝗿𝗸𝘀</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../_static/pone.0237978.g001.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Hyperparameter Optimization using Optuna" href="optuna.html" />
    <link rel="prev" title="Modelling with Pipelines" href="pipelines.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/pone.0237978.g001.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">𝗜𝗻𝗲𝗳𝗳𝗶𝗰𝗶𝗲𝗻𝘁 𝗡𝗲𝘁𝘄𝗼𝗿𝗸𝘀</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MLOPS ZOOMCAMP
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/01-intro/notes.html">
   Preliminaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/02-mlflow/notes.html">
   Experiment Tracking and Model Management
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/03-prefect/notes.html">
   Orchestration and ML Pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/04-deployment/notes.html">
   Model Deployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/05-monitoring/notes.html">
   Model Monitoring
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../mlops/06-best-practices/notes.html">
   Best practices
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MODEL DEPLOYMENT
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../deployment/production-code.html">
   Packaging Production Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../deployment/model-serving-api.html">
   Prediction Serving API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../deployment/docker.html">
   Containerization with Docker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../deployment/cicd-pipelines.html">
   Continuous Integration and Deployment Pipelines
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  FUNDAMENTALS
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="pipelines.html">
   Modelling with Pipelines
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Blending and Stacking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="optuna.html">
   Hyperparameter Optimization using Optuna
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="missing.html">
   Handling Missing Values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DEEP LEARNING
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="backpropagation.html">
   Backpropagation on DAGs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/01-tensorflow-nn.html">
   TensorFlow Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/02-tensorflow-mechanics.html">
   Mechanics of TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/03-tensorflow-activations.html">
   Activation Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/04-tensorflow-optim-init.html">
   Initialization and Optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/05-tensorflow-cnn.html">
   Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tensorflow/06-tensorflow-rnns.html">
   Recurrent Neural Networks
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/notebooks/fundamentals/blending-stacking.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/particle1331/inefficient-networks"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/particle1331/inefficient-networks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/fundamentals/blending-stacking.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imdb-reviews-dataset">
   IMDb Reviews Dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-and-test-split">
     Train and test split
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stacking-models">
   Stacking models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-base-models">
     Training base models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generated-meta-features">
     Generated meta-features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-comparison">
     Performance comparison
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-results">
     Initial results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stacking-with-warm-start">
   Stacking with warm start
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reproducing-initial-results">
     Reproducing initial results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#blending">
   Blending
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizing-auc">
     Optimizing AUC
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-blending">
     Results with blending
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-blending-ranked-probabilities">
     Results with blending ranked probabilities
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelizing-training">
   Parallelizing Training
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consistency-of-serial-and-parallel-implementation">
     Consistency of serial and parallel implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparing-training-times-between-serial-and-parallel">
     Comparing training times between serial and parallel
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-of-timing-runs">
     Results of timing runs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-four-levels">
     Results with four levels
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Blending and Stacking</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imdb-reviews-dataset">
   IMDb Reviews Dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-and-test-split">
     Train and test split
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stacking-models">
   Stacking models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-base-models">
     Training base models
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generated-meta-features">
     Generated meta-features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-comparison">
     Performance comparison
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initial-results">
     Initial results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stacking-with-warm-start">
   Stacking with warm start
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reproducing-initial-results">
     Reproducing initial results
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#blending">
   Blending
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizing-auc">
     Optimizing AUC
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-blending">
     Results with blending
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-blending-ranked-probabilities">
     Results with blending ranked probabilities
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallelizing-training">
   Parallelizing Training
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#consistency-of-serial-and-parallel-implementation">
     Consistency of serial and parallel implementation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparing-training-times-between-serial-and-parallel">
     Comparing training times between serial and parallel
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-of-timing-runs">
     Results of timing runs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#results-with-four-levels">
     Results with four levels
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="blending-and-stacking">
<h1>Blending and Stacking<a class="headerlink" href="#blending-and-stacking" title="Permalink to this headline">¶</a></h1>
<p><img alt="Status" src="https://img.shields.io/static/v1.svg?label=Status&amp;message=Finished&amp;color=brightgreen" />
<a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/master/docs/notebooks/fundamentals/blending-stacking.ipynb"><img alt="Source" src="https://img.shields.io/static/v1.svg?label=GitHub&amp;message=Source&amp;color=181717&amp;logo=GitHub" /></a>
<a class="reference external" href="https://github.com/particle1331/inefficient-networks"><img alt="Stars" src="https://img.shields.io/github/stars/particle1331/inefficient-networks?style=social" /></a></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>𝗔𝘁𝘁𝗿𝗶𝗯𝘂𝘁𝗶𝗼𝗻: Builds on algorithms discussed in Approaching ensembling and stacking of AAAMLP.(github.com/abhishekkrthakur/approachingalmost/blob/master/AAAMLP.pdf)
</pre></div>
</div>
<hr class="docutils" />
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, we will implement two ensembling techniques called <strong>stacking</strong> and <strong>blending</strong>. Ensembling techniques combine models to obtain better predictive performance than could be obtained from any single model. Combining models means that shortcomings of each single model get balanced out.</p>
<p>Stacking and blending ensembles a diverse group of strong learners that are trained on the same task. In contrast to bagging which is also an ensembling technique that combines weak learners.</p>
<br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">TruncatedSVD</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span><span class="p">,</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">,</span> <span class="n">clone</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="kn">from</span> <span class="nn">matplotlib_inline</span> <span class="kn">import</span> <span class="n">backend_inline</span>
<span class="n">backend_inline</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        
<span class="n">NUM_FOLDS</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="imdb-reviews-dataset">
<h2>IMDb Reviews Dataset<a class="headerlink" href="#imdb-reviews-dataset" title="Permalink to this headline">¶</a></h2>
<p>The dataset consists of 50,000 IMDb movie reviews selected for sentiment analysis. The sentiment of reviews is binary, with rating less than 5 is set to a sentiment score of 0, and rating at least 7 is set to a sentiment score of 1. No individual movie has more than 30 reviews.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">USER</span><span class="o">=</span><span class="s2">&quot;ymanojkumar023&quot;</span>
<span class="nv">DATASET</span><span class="o">=</span><span class="s2">&quot;kumarmanoj-bag-of-words-meets-bags-of-popcorn&quot;</span>
<span class="nv">DATA_DIR</span><span class="o">=</span>./data
kaggle datasets download -d <span class="si">${</span><span class="nv">USER</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATASET</span><span class="si">}</span> -p <span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>
unzip <span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATASET</span><span class="si">}</span>.zip -d <span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATASET</span><span class="si">}</span> &gt; /dev/null
rm <span class="si">${</span><span class="nv">DATA_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATASET</span><span class="si">}</span>.zip
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████| 52.4M/52.4M [00:16&lt;00:00, 3.38MB/s]
</pre></div>
</div>
<div class="section" id="train-and-test-split">
<h3>Train and test split<a class="headerlink" href="#train-and-test-split" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/kumarmanoj-bag-of-words-meets-bags-of-popcorn/labeledTrainData.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>       id  sentiment                                             review
0  5814_8          1  With all this stuff going down at the moment w...
1  2381_9          1  \The Classic War of the Worlds\&quot; by Timothy Hi...
2  7759_3          0  The film starts with a manager (Nicholas Bell)...
3  3630_4          0  It must be assumed that those who praised this...
4  9495_8          1  Superbly trashy and wondrously unpretentious 8...
(25000, 3)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1    12500
0    12500
Name: sentiment, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Perhaps a better approach would be to group reviews for the same movie in either the train of the test set. But we don’t have that data available.</p>
</div>
</div>
<div class="section" id="stacking-models">
<h2>Stacking models<a class="headerlink" href="#stacking-models" title="Permalink to this headline">¶</a></h2>
<p>The idea with stacking is that predictions of models can be used as features to train new models. In principle, this process can be repeated indefinitely to train further models. To avoid overfitting, the process incorporates cross-validation folds. This just makes sure that data does not get leaked in the further layers.</p>
<p><strong>Stacking algorithm with cross-validation</strong></p>
<ol class="simple">
<li><p>Split train datasets into <span class="math notranslate nohighlight">\(k\)</span> folds <span class="math notranslate nohighlight">\(({\mathsf X}_0, {\mathsf y}_0), \ldots, ({\mathsf X}_{k-1}, {\mathsf y}_{k-1})\)</span> and set test dataset <span class="math notranslate nohighlight">\(\mathsf X.\)</span></p></li>
<li><p>For <span class="math notranslate nohighlight">\(0 \leq i \leq k-1\)</span> and for each base model <span class="math notranslate nohighlight">\(\mathsf m_q:\)</span></p>
<ul class="simple">
<li><p>Fit model <span class="math notranslate nohighlight">\(\mathsf m_q\)</span> on <span class="math notranslate nohighlight">\(\bigcup_{j\neq i} ({\mathsf X}_j, {\mathsf y}_j).\)</span></p></li>
<li><p>Predict probabilities <span class="math notranslate nohighlight">\({{\mathsf p}^q}_i = \mathsf m_q({\mathsf X}_i)\)</span> using trained model.</p></li>
</ul>
</li>
<li><p>Fit model <span class="math notranslate nohighlight">\(\mathsf m_q\)</span> on <span class="math notranslate nohighlight">\(\bigcup_j ({\mathsf X}_j, {\mathsf y}_j)\)</span> and predict on <span class="math notranslate nohighlight">\(\mathsf X\)</span> to get <span class="math notranslate nohighlight">\({{\mathsf p}^q}.\)</span></p></li>
<li><p>Stack predict probabilities to get metadatasets:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\((\bar{\mathsf X}_0, {\mathsf y}_0), \ldots, (\bar{\mathsf X}_{k-1}, {\mathsf y}_{k-1})\)</span> with <span class="math notranslate nohighlight">\(\bar{\mathsf X}_i = \left[{{\mathsf p}^1}_i \mid {{\mathsf p}^2}_i \mid \ldots \right]\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\bar{\mathsf X} = \left[{\mathsf p}^1 \mid {\mathsf p}^2 \mid \ldots\right]\)</span></p></li>
</ul>
</li>
<li><p>Repeat for another set of models with the train and test metadatasets.</p></li>
</ol>
<p>Note that after generating meta-features, the models will be retrained on the complete training set and predict on the test set to create test meta-features. This makes the test set look like an extra fold, so that cross-validation performance should be a good predictor of test performance.</p>
<div class="section" id="training-base-models">
<h3>Training base models<a class="headerlink" href="#training-base-models" title="Permalink to this headline">¶</a></h3>
<p>Splitting the dataset and creating stratified folds:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span> 
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> 
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span>
<span class="p">)</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test</span>  <span class="o">=</span> <span class="n">test</span> <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">NUM_FOLDS</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">val_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="p">)):</span>
    <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_</span><span class="p">,</span> <span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sentiment</th>
      <th>review</th>
      <th>fold</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>This movie is just plain dumb.&lt;br /&gt;&lt;br /&gt;From...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Dahmer, a young confused man. Dahmer, a confus...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>May the saints preserve us, because this movie...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>The combination of reading the Novella and vie...</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>Daniel Day Lewis in My Left Foot gives us one ...</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sentiment</th>
      <th>review</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I read that \There's a Girl in My Soup\" came ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>This film pulls you in from the get-go because...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>From the awful death scenes to guns that fire ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>I saw that movie few days ago. This movie is s...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>For a film with so much promise it was disappo...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Base models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
        <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">lr_cnt</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">CountVectorizer</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">rf_svd</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Perform stacking algorithm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basemodels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> 
    <span class="s1">&#39;lr_cnt&#39;</span><span class="p">:</span> <span class="n">lr_cnt</span><span class="p">,</span> 
    <span class="s1">&#39;rf_svd&#39;</span><span class="p">:</span> <span class="n">rf_svd</span>
<span class="p">}</span>

<span class="n">acc_score</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">roc_score</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>

<span class="n">cv_scores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level 0 preds: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">rocs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_FOLDS</span><span class="p">):</span>
        <span class="n">train_fld</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold != </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">train_oof</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold == </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Create train meta-features</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">basemodels</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">train_fld</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
            <span class="n">y</span><span class="o">=</span><span class="n">train_fld</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_oof</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

        <span class="c1"># Compute cv scores</span>
        <span class="n">roc</span> <span class="o">=</span> <span class="n">roc_score</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">acc_score</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">rocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
        <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, roc=</span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, acc=</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;roc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rocs</span><span class="p">),</span>
        <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accs</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Create test meta-features</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">basemodels</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>
    <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 0 preds: lr
fold=0, roc=0.9381, acc=0.8585
fold=1, roc=0.9325, acc=0.8570
fold=2, roc=0.9340, acc=0.8610
fold=3, roc=0.9295, acc=0.8502
fold=4, roc=0.9271, acc=0.8558

Level 0 preds: lr_cnt
fold=0, roc=0.9486, acc=0.8855
fold=1, roc=0.9419, acc=0.8765
fold=2, roc=0.9474, acc=0.8812
fold=3, roc=0.9436, acc=0.8780
fold=4, roc=0.9382, acc=0.8715

Level 0 preds: rf_svd
fold=0, roc=0.8831, acc=0.7985
fold=1, roc=0.8762, acc=0.7975
fold=2, roc=0.8792, acc=0.7973
fold=3, roc=0.8731, acc=0.7963
fold=4, roc=0.8795, acc=0.7995
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="generated-meta-features">
<h3>Generated meta-features<a class="headerlink" href="#generated-meta-features" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sentiment</th>
      <th>review</th>
      <th>fold</th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>This movie is just plain dumb.&lt;br /&gt;&lt;br /&gt;From...</td>
      <td>0</td>
      <td>0.052181</td>
      <td>0.001930</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Dahmer, a young confused man. Dahmer, a confus...</td>
      <td>0</td>
      <td>0.029885</td>
      <td>0.000006</td>
      <td>0.30</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>May the saints preserve us, because this movie...</td>
      <td>0</td>
      <td>0.052702</td>
      <td>0.000440</td>
      <td>0.32</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>The combination of reading the Novella and vie...</td>
      <td>0</td>
      <td>0.917899</td>
      <td>0.996462</td>
      <td>0.65</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>Daniel Day Lewis in My Left Foot gives us one ...</td>
      <td>0</td>
      <td>0.982799</td>
      <td>0.999165</td>
      <td>0.86</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sentiment</th>
      <th>review</th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>I read that \There's a Girl in My Soup\" came ...</td>
      <td>0.021305</td>
      <td>0.000098</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>This film pulls you in from the get-go because...</td>
      <td>0.799816</td>
      <td>0.673102</td>
      <td>0.75</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>From the awful death scenes to guns that fire ...</td>
      <td>0.066688</td>
      <td>0.009249</td>
      <td>0.17</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>I saw that movie few days ago. This movie is s...</td>
      <td>0.969935</td>
      <td>0.988239</td>
      <td>0.65</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>For a film with so much promise it was disappo...</td>
      <td>0.062784</td>
      <td>0.000074</td>
      <td>0.26</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="performance-comparison">
<h3>Performance comparison<a class="headerlink" href="#performance-comparison" title="Permalink to this headline">¶</a></h3>
<p>Performance of single models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;xgb_1&#39;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cv_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;test_acc&#39;</span><span class="p">,</span> <span class="s1">&#39;cv_roc&#39;</span><span class="p">,</span> <span class="s1">&#39;test_roc&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="s1">&#39;test_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">acc_score</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="s1">&#39;test_roc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">roc_score</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">_0&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="s1">&#39;cv_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="s1">&#39;cv_roc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;roc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;roc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Training a stacking model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;_0&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="n">basemodels</span><span class="p">[</span><span class="s1">&#39;xgb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">)</span>
<span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;xgb&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level 1 preds: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">rocs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">accs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_FOLDS</span><span class="p">):</span>
    <span class="n">train_fld</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold != </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">train_oof</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold == </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Create train meta-features</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">basemodels</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">train_fld</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">train_fld</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span>
    <span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_oof</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_oof</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

    <span class="c1"># Compute cv scores</span>
    <span class="n">roc</span> <span class="o">=</span> <span class="n">roc_score</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">acc_score</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">rocs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
    <span class="n">accs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, roc=</span><span class="si">{</span><span class="n">roc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, acc=</span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;roc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rocs</span><span class="p">),</span>
    <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accs</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Create test meta-features</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">basemodels</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 1 preds: xgb
fold=0, roc=0.9488, acc=0.8838
fold=1, roc=0.9428, acc=0.8760
fold=2, roc=0.9470, acc=0.8760
fold=3, roc=0.9429, acc=0.8792
fold=4, roc=0.9378, acc=0.8738
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="initial-results">
<h3>Initial results<a class="headerlink" href="#initial-results" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span> <span class="s1">&#39;test_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">acc_score</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span> <span class="s1">&#39;test_roc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">roc_score</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">_1&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span> <span class="s1">&#39;cv_acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_1&quot;</span><span class="p">,</span> <span class="s1">&#39;cv_roc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;roc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="s1">&#39;roc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Stacked model has relatively better test performance and within range of best cv-performance. This shows that stacking can significantly improve over single models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cv_acc</th>
      <th>test_acc</th>
      <th>cv_roc</th>
      <th>test_roc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lr_0</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.871</td>
      <td>0.9322 ± 0.0038</td>
      <td>0.9404</td>
    </tr>
    <tr>
      <th>lr_cnt_0</th>
      <td>0.8786 ± 0.0047</td>
      <td>0.8838</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9473</td>
    </tr>
    <tr>
      <th>rf_svd_0</th>
      <td>0.7978 ± 0.0011</td>
      <td>0.7976</td>
      <td>0.8782 ± 0.0034</td>
      <td>0.8794</td>
    </tr>
    <tr>
      <th>xgb_1</th>
      <td>0.8778 ± 0.0035</td>
      <td>0.886</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9498</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="stacking-with-warm-start">
<h2>Stacking with warm start<a class="headerlink" href="#stacking-with-warm-start" title="Permalink to this headline">¶</a></h2>
<p>Note the modular nature of the algorithm allowed us to copy the code above with minimal change for the XGBoost metamodel. This allows us to collect all our work above in a single class, allowing automated training and inference. To indicate the number of rounds of stacking performed, we introduce <strong>levels</strong>. This is analogous to layers in a neural network.</p>
<p>We also include <strong>warm starting</strong>. This means that we use earlier levels in a trained stacker and stack them with layers. Only the new layers will be trained. It adds some complexity to the implementation, but warm-starting is a desirable feature, especially when training base models are expensive and we want to perform rapid iteration only on top models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StackingClassifier</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Implements model stacking with predict probabilities.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> 
            <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>

            <span class="c1"># advanced usage</span>
            <span class="n">warm_start_level</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">warm_start_stack</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        models:</span>
<span class="sd">            Dictionary of name-model pairs for each level. </span>
<span class="sd">            Some constraints:</span>
<span class="sd">                1) Unique names level-wise</span>
<span class="sd">                2) Single model at last level</span>
<span class="sd">                3) Model implements fit and predict_proba</span>

<span class="sd">        verbose: 0 = not verbose, 1 = verbose</span>

<span class="sd">        num_folds: No. of stratified cross-validation folds</span>
<span class="sd">        </span>
<span class="sd">        metrics: </span>
<span class="sd">            Name-metric pairs for such that metric is a function of </span>
<span class="sd">            (y_true, y_predict_proba). This defaults to ROC-AUC. If</span>
<span class="sd">            there is warm-starting, defaults to metrics used by ref</span>
<span class="sd">            stack.</span>

<span class="sd">        warm_start_level:</span>
<span class="sd">            Warm-starting refers to using levels of existing trained stack </span>
<span class="sd">            (stack passed in warm_start_stack) before warm_start_level.</span>
<span class="sd">            This is assumed to be in 1 &lt;= j &lt; len(warm_start_stack.models).</span>
<span class="sd">        </span>
<span class="sd">        warm_start_stack: </span>
<span class="sd">            Use models and features from this stack so that predictions </span>
<span class="sd">            of single models can be easily combined. And earlier models </span>
<span class="sd">            need not be retrained. Some constraints:</span>
<span class="sd">                1) Earlier levels have trained models</span>
<span class="sd">                2) Earlier levels have metafeatures</span>
<span class="sd">                3) Passed `self.models` will be appended to model dict </span>
<span class="sd">                list up to warm start level.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[{</span><span class="n">m</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">num_folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;roc_score&#39;</span><span class="p">:</span>  <span class="n">roc_auc_score</span><span class="p">}</span> <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metrics</span>
        
        <span class="c1"># Warm starting</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">warm_start_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">warm_start_stack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warm_start_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span> <span class="o">=</span> <span class="n">warm_start_level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span> <span class="o">=</span> <span class="n">warm_start_stack</span>

            <span class="c1"># Ignore upper level meta-features of reference stack</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">skip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">train_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="n">_</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">]]</span>
            
            <span class="c1"># Select cv scores of reference stack to include</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            
            <span class="c1"># Update metrics to reference stack if None, else use passed metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">metrics</span> <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metrics</span>
            
            <span class="c1"># Base models + stack top models</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>
            
            <span class="c1"># Warm start model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> 
                <span class="n">start_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span>
            <span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">start_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iteratively fit base models with metafeatures.</span>

<span class="sd">        Some constraints on the input:</span>
<span class="sd">            1) X must not have column named &#39;fold&#39;</span>
<span class="sd">            2) X must not have column named &#39;target&#39;</span>
<span class="sd">            3) X must not have column named f&#39;{q}_{l}&#39; for q model name, and 0 &lt;= l &lt; len(models)</span>
<span class="sd">            4) The target vector y is binary (0 or 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Validate data (read docstring above)</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Create folds</span>
        <span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">train</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">val_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
            <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_</span><span class="p">,</span> <span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>
        
        <span class="c1"># Create metafeatures for each level</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
            <span class="n">basemodels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> preds: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
                <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">):</span>
                    <span class="n">train_fld</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold != </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">train_oof</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold == </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="c1"># Create train meta-features</span>
                    <span class="n">model_</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                    <span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="n">X</span><span class="o">=</span><span class="n">train_fld</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> 
                        <span class="n">y</span><span class="o">=</span><span class="n">train_fld</span><span class="o">.</span><span class="n">target</span>
                    <span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">model_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_oof</span><span class="p">[</span><span class="n">columns</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_oof</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

                    <span class="c1"># Compute cv scores</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                        <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Fit on entire train for inference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="n">train</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># Save features table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="n">train</span>

        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Return prediction probabilities for each row of the input.&quot;&quot;&quot;</span>

        <span class="c1"># Predict with trained models</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">basemodels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">columns</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
        
        <span class="c1"># Return prediction of top-most model.</span>
        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_pred</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The vectorizers expect 1-dimensional vectors<span class="math notranslate nohighlight">\(,\)</span> so we define a helper transformer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ReviewColumnExtractor</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span> 
        <span class="k">return</span> <span class="n">X</span><span class="o">.</span><span class="n">review</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">ReviewColumnExtractor</span><span class="p">(),</span>
    <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">lr_cnt</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">ReviewColumnExtractor</span><span class="p">(),</span>
    <span class="n">CountVectorizer</span><span class="p">(),</span>
    <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">rf_svd</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">ReviewColumnExtractor</span><span class="p">(),</span>
    <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="n">TruncatedSVD</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
    <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Fitting the stacked models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> <span class="s1">&#39;lr_cnt&#39;</span><span class="p">:</span> <span class="n">lr_cnt</span><span class="p">,</span> <span class="s1">&#39;rf_svd&#39;</span><span class="p">:</span> <span class="n">rf_svd</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;xgb&#39;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">)}</span>
<span class="p">]</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;roc&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span>  <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">),</span>
    <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">stack</span> <span class="o">=</span> <span class="n">StackingClassifier</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<span class="n">stack</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]],</span> <span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 0 preds: lr
fold=0, roc=0.9381, acc=0.8585
fold=1, roc=0.9325, acc=0.8570
fold=2, roc=0.9340, acc=0.8610
fold=3, roc=0.9295, acc=0.8502
fold=4, roc=0.9271, acc=0.8558

Level 0 preds: lr_cnt
fold=0, roc=0.9486, acc=0.8855
fold=1, roc=0.9419, acc=0.8765
fold=2, roc=0.9474, acc=0.8812
fold=3, roc=0.9436, acc=0.8780
fold=4, roc=0.9382, acc=0.8715

Level 0 preds: rf_svd
fold=0, roc=0.8831, acc=0.7985
fold=1, roc=0.8762, acc=0.7975
fold=2, roc=0.8792, acc=0.7973
fold=3, roc=0.8731, acc=0.7963
fold=4, roc=0.8795, acc=0.7995

Level 1 preds: xgb
fold=0, roc=0.9488, acc=0.8838
fold=1, roc=0.9428, acc=0.8760
fold=2, roc=0.9470, acc=0.8760
fold=3, roc=0.9429, acc=0.8792
fold=4, roc=0.9378, acc=0.8738
</pre></div>
</div>
</div>
</div>
<p>Generated probability features can be accessed as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stack</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>review</th>
      <th>target</th>
      <th>fold</th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>xgb_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>This movie is just plain dumb.&lt;br /&gt;&lt;br /&gt;From...</td>
      <td>0</td>
      <td>0</td>
      <td>0.052181</td>
      <td>0.001930</td>
      <td>0.27</td>
      <td>0.011519</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Dahmer, a young confused man. Dahmer, a confus...</td>
      <td>0</td>
      <td>0</td>
      <td>0.029885</td>
      <td>0.000006</td>
      <td>0.30</td>
      <td>0.023870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>May the saints preserve us, because this movie...</td>
      <td>0</td>
      <td>0</td>
      <td>0.052702</td>
      <td>0.000440</td>
      <td>0.32</td>
      <td>0.007410</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The combination of reading the Novella and vie...</td>
      <td>1</td>
      <td>0</td>
      <td>0.917899</td>
      <td>0.996462</td>
      <td>0.65</td>
      <td>0.977768</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Daniel Day Lewis in My Left Foot gives us one ...</td>
      <td>1</td>
      <td>0</td>
      <td>0.982799</td>
      <td>0.999165</td>
      <td>0.86</td>
      <td>0.998865</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Hacking into the models allow us to compute train and test results for single models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute train cv results table</span>
<span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cv_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="p">)</span>

<span class="c1"># Compute cv scores</span>
<span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>                        
            <span class="n">cv_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>
            <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cv_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Compute test scores</span>
<span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]])[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]])[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_0&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">metric_fn</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">sentiment</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]])[:,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">results</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9322 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.8782 ± 0.0034</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.8786 ± 0.0047</td>
      <td>0.7978 ± 0.0011</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9404</td>
      <td>0.9473</td>
      <td>0.8794</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>0.871</td>
      <td>0.8838</td>
      <td>0.7976</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For convenience, we define a helper function for updating results for new stacks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>

    <span class="c1"># Get name of final model</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">q</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute cv scores</span>
    <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cv_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">])</span>
        <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cv_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cv_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">cv_scores</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Compute test scores</span>
        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]])[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">],</span> <span class="n">test_pred</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reproducing-initial-results">
<h3>Reproducing initial results<a class="headerlink" href="#reproducing-initial-results" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span> <span class="c1"># xgb stack</span>
<span class="n">results</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>xgb_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9322 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.8782 ± 0.0034</td>
      <td>0.9439 ± 0.0038</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.8786 ± 0.0047</td>
      <td>0.7978 ± 0.0011</td>
      <td>0.8778 ± 0.0035</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9404</td>
      <td>0.9473</td>
      <td>0.8794</td>
      <td>0.9498</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>0.871</td>
      <td>0.8838</td>
      <td>0.7976</td>
      <td>0.886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The results are consistent with what we obtained above. This means that our involved implementation somehow worked and is able to produce reproducible results.</p>
</div>
</div>
<div class="section" id="blending">
<h2>Blending<a class="headerlink" href="#blending" title="Permalink to this headline">¶</a></h2>
<p>A simple method of combining predictions of multiple models is to just take the weighted average of their predictions for some coefficients. This technique is aptly called <strong>blending</strong>. Note that the coefficients can be hand picked, but as we will show below, they can also be learned.</p>
<p>For the sake of comparison, we will be using the same base models that we used above. Although in actual practice, we would spend as much time as possible to improving the base models, and only use stacking for marginal gains.</p>
<p>Blending works best when the base probabilities uncorrelated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stack</span><span class="o">.</span><span class="n">train_</span><span class="p">[[</span><span class="s1">&#39;lr_0&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_cnt_0&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_svd_0&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lr_0</th>
      <td>1.000000</td>
      <td>0.884571</td>
      <td>0.832398</td>
    </tr>
    <tr>
      <th>lr_cnt_0</th>
      <td>0.884571</td>
      <td>1.000000</td>
      <td>0.727050</td>
    </tr>
    <tr>
      <th>rf_svd_0</th>
      <td>0.832398</td>
      <td>0.727050</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Looks fairly uncorrelated. Let’s try to blend the probabilities using some hand-designed coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># AUC is scale invariant, so we dont bother dividing by total weights</span>
<span class="n">metafeatures</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">train_</span><span class="p">[[</span><span class="s1">&#39;lr_0&#39;</span><span class="p">,</span> <span class="s1">&#39;lr_cnt_0&#39;</span><span class="p">,</span> <span class="s1">&#39;rf_svd_0&#39;</span><span class="p">]]</span>
<span class="n">avg_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">metafeatures</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">wtd_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">metafeatures</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rank_avg_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">metafeatures</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rank_wtd_preds</span> <span class="o">=</span> <span class="p">(</span><span class="n">metafeatures</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">*</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auc (train) (averaged):       </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">avg_preds</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auc (train) (wtd. avg):       </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">wtd_preds</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auc (train) (rank avg):       </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rank_avg_preds</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;auc (train) (wtd. rank avg):  </span><span class="si">{</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rank_wtd_preds</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>auc (train) (averaged):       0.9468
auc (train) (wtd. avg):       0.9483
auc (train) (rank avg):       0.9423
auc (train) (wtd. rank avg):  0.9486
</pre></div>
</div>
</div>
</div>
<div class="section" id="optimizing-auc">
<h3>Optimizing AUC<a class="headerlink" href="#optimizing-auc" title="Permalink to this headline">¶</a></h3>
<p>Since these coefficients are hand-designed, we may want to devise a strategy for automatically finding the optimal coefficients for blending. This is accomplished by the folowing class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Blender</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Implement blending that maximizes AUC score.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find optimal blending coefficients.&quot;&quot;&quot;</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_auc</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return blended probabilities for class 0 and class 1.&quot;&quot;&quot;</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span>
            
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pred</span><span class="p">,</span> <span class="n">pred</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_auc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate AUC of blended predict probas.&quot;&quot;&quot;</span>

        <span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">coef</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">auc</span> <span class="c1"># min -auc = max auc</span>
    
    <span class="k">def</span> <span class="nf">_optimize_auc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maximize AUC as a bound-constrained optimization problem using Nelder-Mead method </span>
<span class="sd">        with coefficients initialized from a Dirichlet distribution with a = [1, ..., 1]. </span>
<span class="sd">        </span>
<span class="sd">        Reference: </span>
<span class="sd">        https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">partial_loss</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auc</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span> 
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">init_coef</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">dirichlet</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">minimize</span><span class="p">(</span><span class="n">partial_loss</span><span class="p">,</span> <span class="n">init_coef</span><span class="p">,</span> 
                        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> 
                        <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Calculating CV scores for blender model by warm-starting previous trained stack:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blender_stack</span> <span class="o">=</span> <span class="n">StackingClassifier</span><span class="p">(</span>
    <span class="n">models</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;blender&#39;</span><span class="p">:</span> <span class="n">Blender</span><span class="p">()}],</span>
    <span class="n">warm_start_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">warm_start_stack</span><span class="o">=</span><span class="n">stack</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 1 preds: blender
fold=0, roc=0.9540, acc=0.8875
fold=1, roc=0.9473, acc=0.8588
fold=2, roc=0.9516, acc=0.8688
fold=3, roc=0.9460, acc=0.8675
fold=4, roc=0.9437, acc=0.8610
</pre></div>
</div>
</div>
</div>
<p>Note that the metrics are inherited from the reference stack since we provided none. Also note that level 1 meta-features are not inherited by the warm-started stack. The inherited models are also only up to the warm start level.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blender_stack</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>review</th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>target</th>
      <th>fold</th>
      <th>blender_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>This movie is just plain dumb.&lt;br /&gt;&lt;br /&gt;From...</td>
      <td>0.052181</td>
      <td>0.001930</td>
      <td>0.27</td>
      <td>0</td>
      <td>0</td>
      <td>0.032093</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Dahmer, a young confused man. Dahmer, a confus...</td>
      <td>0.029885</td>
      <td>0.000006</td>
      <td>0.30</td>
      <td>0</td>
      <td>0</td>
      <td>0.028978</td>
    </tr>
    <tr>
      <th>2</th>
      <td>May the saints preserve us, because this movie...</td>
      <td>0.052702</td>
      <td>0.000440</td>
      <td>0.32</td>
      <td>0</td>
      <td>0</td>
      <td>0.035302</td>
    </tr>
    <tr>
      <th>3</th>
      <td>The combination of reading the Novella and vie...</td>
      <td>0.917899</td>
      <td>0.996462</td>
      <td>0.65</td>
      <td>1</td>
      <td>0</td>
      <td>0.718977</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Daniel Day Lewis in My Left Foot gives us one ...</td>
      <td>0.982799</td>
      <td>0.999165</td>
      <td>0.86</td>
      <td>1</td>
      <td>0</td>
      <td>0.749406</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blender_stack</span><span class="o">.</span><span class="n">models</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;lr&#39;: Pipeline(steps=[(&#39;reviewcolumnextractor&#39;, ReviewColumnExtractor()),
                  (&#39;tfidfvectorizer&#39;, TfidfVectorizer(max_features=1000)),
                  (&#39;logisticregression&#39;, LogisticRegression(random_state=42))]),
  &#39;lr_cnt&#39;: Pipeline(steps=[(&#39;reviewcolumnextractor&#39;, ReviewColumnExtractor()),
                  (&#39;countvectorizer&#39;, CountVectorizer()),
                  (&#39;logisticregression&#39;,
                   LogisticRegression(random_state=42, solver=&#39;liblinear&#39;))]),
  &#39;rf_svd&#39;: Pipeline(steps=[(&#39;reviewcolumnextractor&#39;, ReviewColumnExtractor()),
                  (&#39;tfidfvectorizer&#39;, TfidfVectorizer()),
                  (&#39;truncatedsvd&#39;,
                   TruncatedSVD(n_components=120, random_state=42)),
                  (&#39;randomforestclassifier&#39;,
                   RandomForestClassifier(n_jobs=-1, random_state=42))])},
 {&#39;blender&#39;: &lt;__main__.Blender at 0x17737ec10&gt;}]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="results-with-blending">
<h3>Results with blending<a class="headerlink" href="#results-with-blending" title="Permalink to this headline">¶</a></h3>
<p>Adding blending scores to results table. Blending has significantly better AUC scores but significantly worse accuracy scores than gradient boosting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">blender_stack</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>xgb_1</th>
      <th>blender_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9322 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.8782 ± 0.0034</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9485 ± 0.0038</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.8786 ± 0.0047</td>
      <td>0.7978 ± 0.0011</td>
      <td>0.8778 ± 0.0035</td>
      <td>0.8687 ± 0.0101</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9404</td>
      <td>0.9473</td>
      <td>0.8794</td>
      <td>0.9498</td>
      <td>0.9538</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>0.871</td>
      <td>0.8838</td>
      <td>0.7976</td>
      <td>0.886</td>
      <td>0.8794</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Doing the same for blending with rank. Note that don’t have an accuracy metric. This is because we only use this type of model for comparing scores.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blender_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;roc&#39;</span><span class="p">:</span> <span class="n">roc_auc_score</span><span class="p">}</span>

<span class="n">blender_rk_stack</span> <span class="o">=</span> <span class="n">StackingClassifier</span><span class="p">(</span>
    <span class="n">models</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;blender_rk&#39;</span><span class="p">:</span> <span class="n">Blender</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)}],</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">blender_metrics</span><span class="p">,</span>
    <span class="n">warm_start_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">warm_start_stack</span><span class="o">=</span><span class="n">stack</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 1 preds: blender_rk
fold=0, roc=0.9544
fold=1, roc=0.9481
fold=2, roc=0.9527
fold=3, roc=0.9477
fold=4, roc=0.9437
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="results-with-blending-ranked-probabilities">
<h3>Results with blending ranked probabilities<a class="headerlink" href="#results-with-blending-ranked-probabilities" title="Permalink to this headline">¶</a></h3>
<p>Blending ranked probabilities has even better cross-validation scores for AUC compared to blending raw probabilities. Recall that we observed the same phenomenon above for hand picked coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">blender_rk_stack</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>xgb_1</th>
      <th>blender_1</th>
      <th>blender_rk_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9322 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.8782 ± 0.0034</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9485 ± 0.0038</td>
      <td>0.9493 ± 0.0038</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.8786 ± 0.0047</td>
      <td>0.7978 ± 0.0011</td>
      <td>0.8778 ± 0.0035</td>
      <td>0.8687 ± 0.0101</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9404</td>
      <td>0.9473</td>
      <td>0.8794</td>
      <td>0.9498</td>
      <td>0.9538</td>
      <td>0.9537</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>0.871</td>
      <td>0.8838</td>
      <td>0.7976</td>
      <td>0.886</td>
      <td>0.8794</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Remark.</strong> If we assume that each fold has the same error distribution, then cross-validation performance should approximate the test AUC which can be thought of as just another fold of training data. Indeed, we can see this from the above results.</p>
</div>
</div>
<div class="section" id="parallelizing-training">
<h2>Parallelizing Training<a class="headerlink" href="#parallelizing-training" title="Permalink to this headline">¶</a></h2>
<p>Generating features require training each model on each fold. This is very slow. Note that each training process are independent of each other as they only use static features from the previous level, so in principle can be easily parallelized. Note that we parallelize only the training on cross-validation folds.</p>
<p><strong>Remarks.</strong> Parallelizing training on cross-validation folds is implemented using <code class="docutils literal notranslate"><span class="pre">joblib.Parallel</span></code>. Here we set <code class="docutils literal notranslate"><span class="pre">backend='loky'</span></code> as this is the setting that works on an M1. Also, setting <code class="docutils literal notranslate"><span class="pre">nthread=1</span></code> for XGBClassifier with backend <code class="docutils literal notranslate"><span class="pre">loky</span></code> and <code class="docutils literal notranslate"><span class="pre">n_jobs=-1</span></code>. Other settings result in worse times. See this <a class="reference external" href="https://github.com/dmlc/xgboost/issues/2163">issue</a>.</p>
<p>Since joblib pickles every object used inside <code class="docutils literal notranslate"><span class="pre">Parallel</span></code>, we have to use stateless objects and be careful about shared memory. Results below show that there is significant speed up with parallelization using the <code class="docutils literal notranslate"><span class="pre">loky</span></code> backend.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StackingClassifierParallel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Implements model stacking with predict probabilities.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">models</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> 
            <span class="n">metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_folds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;loky&#39;</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

            <span class="c1"># Advanced usage</span>
            <span class="n">warm_start_level</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">warm_start_stack</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        models:</span>
<span class="sd">            Dictionary of name-model pairs for each level. </span>
<span class="sd">            Some constraints:</span>
<span class="sd">                1) Unique names level-wise</span>
<span class="sd">                2) Single model at last level</span>
<span class="sd">                3) Model implements fit and predict_proba</span>

<span class="sd">        verbose: 0 = not verbose, 1 = verbose</span>

<span class="sd">        num_folds: No. of stratified cross-validation folds</span>
<span class="sd">        </span>
<span class="sd">        backend: Default &quot;loky&quot;. Backend for internal joblib.Parallel object.</span>

<span class="sd">        n_jobs: No. of jobs passed to internal joblib.Parallel object.</span>

<span class="sd">        metrics: </span>
<span class="sd">            Name-metric pairs for such that metric is a function of </span>
<span class="sd">            (y_true, y_predict_proba). This defaults to ROC-AUC. If</span>
<span class="sd">            there is warm-starting, defaults to metrics used by ref</span>
<span class="sd">            stack.</span>

<span class="sd">        warm_start_level:</span>
<span class="sd">            Warm-starting refers to using levels of existing trained stack </span>
<span class="sd">            (stack passed in warm_start_stack) before warm_start_level.</span>
<span class="sd">            This is assumed to be in 1 &lt;= j &lt; len(warm_start_stack.models).</span>
<span class="sd">        </span>
<span class="sd">        warm_start_stack: </span>
<span class="sd">            Use models and features from this stack so that predictions </span>
<span class="sd">            of single models can be easily combined. And earlier models </span>
<span class="sd">            need not be retrained. Some constraints:</span>
<span class="sd">                1) Earlier levels have trained models</span>
<span class="sd">                2) Earlier levels have metafeatures</span>
<span class="sd">                3) Passed `self.models` will be appended to model dict </span>
<span class="sd">                list up to warm start level.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[{</span><span class="n">m</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">m</span><span class="p">])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> <span class="o">=</span> <span class="n">num_folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;roc_score&#39;</span><span class="p">:</span>  <span class="n">roc_auc_score</span><span class="p">}</span> <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metrics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>

        <span class="c1"># Warm starting</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">warm_start_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">warm_start_stack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warm_start_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span> <span class="o">=</span> <span class="n">warm_start_level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span> <span class="o">=</span> <span class="n">warm_start_stack</span>

            <span class="c1"># Ignore upper level meta-features of reference stack</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">skip</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">train_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="n">_</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span><span class="p">]]</span>
            
            <span class="c1"># Select cv scores of reference stack to include</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">_</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            
            <span class="c1"># Update metrics to reference stack if None, else use passed metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">metrics</span> <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">metrics</span>
            
            <span class="c1"># Base models + stack top models</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm_stack</span><span class="o">.</span><span class="n">models</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span>
            
            <span class="c1"># Warm start model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">train_</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> 
                <span class="n">start_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">warm_level</span>
            <span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">start_level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iteratively fit base models with metafeatures.</span>

<span class="sd">        Some constraints on the input:</span>
<span class="sd">            1) X must not have column named &#39;fold&#39;</span>
<span class="sd">            2) X must not have column named &#39;target&#39;</span>
<span class="sd">            3) X must not have column named f&#39;{q}_{l}&#39; for q model name, and 0 &lt;= l &lt; len(models)</span>
<span class="sd">            4) The target vector y is binary (0 or 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="c1"># Create folds: add fold, target column to train</span>
        <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_kfolds</span><span class="p">(</span><span class="n">train</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>
        
        <span class="c1"># Create metafeatures for each level</span>
        <span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>

                <span class="c1"># Fit each current model on prev level meta-features</span>
                <span class="n">basemodels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metafeatures</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> preds: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
                    <span class="c1"># Parallel train on each fold</span>
                    <span class="n">parallel_results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span>
                        <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_fold</span><span class="p">)(</span>
                            <span class="n">train</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> 
                            <span class="n">model</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> 
                            <span class="n">fold</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
                        <span class="p">)</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">)</span>
                    <span class="p">)</span>
                    
                    <span class="c1"># Saving results to meta-features and cv scores</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">metric</span><span class="p">:[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span> 
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">}</span> 
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_folds</span><span class="p">):</span>
                        <span class="n">preds</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">parallel_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold == </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>

                    <span class="c1"># Fit on entire train for inference</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="n">train</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># Save meta-features table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_</span> <span class="o">=</span> <span class="n">train</span>

        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return prediction probabilities for each row of the input.&quot;&quot;&quot;</span>

        <span class="c1"># Predict with trained models</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">basemodels</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">for</span> <span class="n">q</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">basemodels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="n">columns</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred</span>
        
        <span class="c1"># Return prediction of top-most model.</span>
        <span class="n">test_pred</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">test_pred</span><span class="p">,</span> <span class="n">test_pred</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">_get_metafeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get columns for meta-features of previous level models.&quot;&quot;&quot;</span>
        
        <span class="c1"># Example: [&quot;lr_0&quot;, &quot;lr_cnt_0&quot;, &quot;rf_svd_0&quot;] for training &quot;xgb_1&quot;.</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;fold&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_create_kfolds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create stratified folds. Add fold and target column.&quot;&quot;&quot;</span>

        <span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
        <span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">train</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">fold</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">val_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">)):</span>
            <span class="n">train</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_</span><span class="p">,</span> <span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span>
        
        <span class="k">return</span> <span class="n">train</span>


    <span class="k">def</span> <span class="nf">_predict_fold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fold</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predict on cross-validation fold.&quot;&quot;&quot;</span>

        <span class="c1"># Get folds; include target and feature cols.</span>
        <span class="n">train_fld</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold != </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">train_oof</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fold == </span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Fit model.</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_fld</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="n">train_fld</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="c1"># Compute cv scores</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">train_oof</span><span class="p">[</span><span class="n">columns</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">train_oof</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
            <span class="n">message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fold=</span><span class="si">{</span><span class="n">fold</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return out-of-fold predictions.</span>
        <span class="k">return</span> <span class="n">pred</span><span class="p">,</span> <span class="n">scores</span>
</pre></div>
</div>
</div>
</div>
<p>Testing if the parallel implementation reproduces previous results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONWARNINGS&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;ignore::FutureWarning&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONWARNINGS&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;ignore::UserWarning&#39;</span>


<span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> <span class="s1">&#39;lr_cnt&#39;</span><span class="p">:</span> <span class="n">lr_cnt</span><span class="p">,</span> <span class="s1">&#39;rf_svd&#39;</span><span class="p">:</span> <span class="n">rf_svd</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;xgb_pll&#39;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">nthread</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">)}</span>
<span class="p">]</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;roc&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span>  <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">),</span>
    <span class="s1">&#39;acc&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_prob</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">stack_pll</span> <span class="o">=</span> <span class="n">StackingClassifierParallel</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">stack_pll</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]],</span> <span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 0 preds: lr
[Parallel(n_jobs=5)]: Using backend LokyBackend with 5 concurrent workers.
fold=1, roc=0.9325, acc=0.8570
fold=3, roc=0.9295, acc=0.8502
fold=4, roc=0.9271, acc=0.8558
fold=0, roc=0.9381, acc=0.8585
fold=2, roc=0.9340, acc=0.8610
[Parallel(n_jobs=5)]: Done   2 out of   5 | elapsed:    6.4s remaining:    9.6s
[Parallel(n_jobs=5)]: Done   5 out of   5 | elapsed:    6.5s finished

Level 0 preds: lr_cnt
[Parallel(n_jobs=5)]: Using backend LokyBackend with 5 concurrent workers.
fold=3, roc=0.9436, acc=0.8780
fold=0, roc=0.9486, acc=0.8855
fold=1, roc=0.9419, acc=0.8765
fold=2, roc=0.9474, acc=0.8812
fold=4, roc=0.9382, acc=0.8715
[Parallel(n_jobs=5)]: Done   2 out of   5 | elapsed:    8.9s remaining:   13.4s
[Parallel(n_jobs=5)]: Done   5 out of   5 | elapsed:    9.1s finished
[Parallel(n_jobs=5)]: Using backend LokyBackend with 5 concurrent workers.
fold=1, roc=0.8762, acc=0.7975
fold=0, roc=0.8831, acc=0.7985
[Parallel(n_jobs=5)]: Done   2 out of   5 | elapsed:   23.4s remaining:   35.1s
fold=4, roc=0.8795, acc=0.7995
fold=2, roc=0.8792, acc=0.7973
fold=3, roc=0.8731, acc=0.7963
[Parallel(n_jobs=5)]: Done   5 out of   5 | elapsed:   24.1s finished

Level 1 preds: xgb
[Parallel(n_jobs=5)]: Using backend LokyBackend with 5 concurrent workers.
[Parallel(n_jobs=5)]: Done   2 out of   5 | elapsed:    1.9s remaining:    2.9s
fold=0, roc=0.9488, acc=0.8838
fold=1, roc=0.9428, acc=0.8760
fold=3, roc=0.9429, acc=0.8792
fold=2, roc=0.9470, acc=0.8760
[Parallel(n_jobs=5)]: Done   5 out of   5 | elapsed:    2.6s finished
fold=4, roc=0.9378, acc=0.8738
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">stack_pll</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Testing warm starting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blender_rk_pll</span> <span class="o">=</span> <span class="n">StackingClassifierParallel</span><span class="p">(</span>
    <span class="n">models</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;blender_rk_pll&#39;</span><span class="p">:</span> <span class="n">Blender</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)}],</span>
    <span class="n">metrics</span><span class="o">=</span><span class="n">blender_metrics</span><span class="p">,</span>
    <span class="n">warm_start_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">warm_start_stack</span><span class="o">=</span><span class="n">stack</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Level 1 preds: blender_rk_pll
[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.
fold=0, roc=0.9544
fold=1, roc=0.9481
fold=2, roc=0.9527
fold=3, roc=0.9477
fold=4, roc=0.9437
[Parallel(n_jobs=1)]: Done   5 out of   5 | elapsed:    1.8s finished
</pre></div>
</div>
</div>
</div>
<div class="section" id="consistency-of-serial-and-parallel-implementation">
<h3>Consistency of serial and parallel implementation<a class="headerlink" href="#consistency-of-serial-and-parallel-implementation" title="Permalink to this headline">¶</a></h3>
<p>The results are consistent for both training from scratch and warm-started stacked models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">blender_rk_pll</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">T</span><span class="p">[[</span><span class="s1">&#39;blender_rk_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blender_rk_pll_1&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_1&#39;</span><span class="p">,</span> <span class="s1">&#39;xgb_pll_1&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>blender_rk_1</th>
      <th>blender_rk_pll_1</th>
      <th>xgb_1</th>
      <th>xgb_pll_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9493 ± 0.0038</td>
      <td>0.9493 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.8778 ± 0.0035</td>
      <td>0.8778 ± 0.0035</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9537</td>
      <td>0.9537</td>
      <td>0.9498</td>
      <td>0.9498</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.886</td>
      <td>0.886</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="comparing-training-times-between-serial-and-parallel">
<h3>Comparing training times between serial and parallel<a class="headerlink" href="#comparing-training-times-between-serial-and-parallel" title="Permalink to this headline">¶</a></h3>
<p>Now we would like to test if there is indeed a speedup and how much. First, we define more models for more levels. In particular, we create a new model which is a linear regression ranking model which we can use for classification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LinearRegressionClassifier</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear regression for model-based AUC optimization.</span>
<span class="sd">    Note that probabilities are transformed to rank scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">(),</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">rank</span><span class="p">())]</span>
</pre></div>
</div>
</div>
</div>
<p>Define the model dictionaries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">level_0</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">ReviewColumnExtractor</span><span class="p">(),</span>
        <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">1000</span><span class="p">),</span>
        <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="p">),</span> 
    
    <span class="s1">&#39;lr_cnt&#39;</span><span class="p">:</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">ReviewColumnExtractor</span><span class="p">(),</span>
        <span class="n">CountVectorizer</span><span class="p">(),</span> 
        <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="p">),</span> 
<span class="p">}</span>

<span class="n">level_1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">),</span>
    <span class="s1">&#39;linreg&#39;</span><span class="p">:</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LinearRegressionClassifier</span><span class="p">()),</span>
    <span class="s1">&#39;xgb&#39;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">eval_metric</span><span class="o">=</span><span class="s2">&quot;logloss&quot;</span><span class="p">,</span> <span class="n">nthread</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">level_2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;linreg&#39;</span><span class="p">:</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LinearRegressionClassifier</span><span class="p">()),</span>
    <span class="s1">&#39;xgb&#39;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">eval_metric</span><span class="o">=</span><span class="s2">&quot;logloss&quot;</span><span class="p">,</span> <span class="n">nthread</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">level_3</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;blender&#39;</span><span class="p">:</span> <span class="n">Blender</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">seed</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<p>Define timing helper function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">time_training</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return model training time vs percentage of train data.&quot;&quot;&quot;</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">[[</span><span class="s1">&#39;review&#39;</span><span class="p">]]])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">sentiment</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">train_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.10</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="n">train_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># cooling down</span>

    <span class="k">return</span> <span class="n">train_times</span>
</pre></div>
</div>
</div>
</div>
<p>Timing runs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">level_0</span><span class="p">,</span> <span class="n">level_1</span><span class="p">,</span> <span class="n">level_2</span><span class="p">,</span> <span class="n">level_3</span><span class="p">]</span>

<span class="n">serial</span> <span class="o">=</span> <span class="n">StackingClassifier</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">blender_metrics</span><span class="p">)</span>
<span class="n">parallel</span> <span class="o">=</span> <span class="n">StackingClassifierParallel</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">blender_metrics</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">serial_times</span> <span class="o">=</span> <span class="n">time_training</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
<span class="n">parallel_times</span> <span class="o">=</span> <span class="n">time_training</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [04:57&lt;00:00, 29.80s/it]
100%|██████████| 10/10 [03:41&lt;00:00, 22.19s/it]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="results-of-timing-runs">
<h3>Results of timing runs<a class="headerlink" href="#results-of-timing-runs" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">serial_times</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Serial&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">parallel_times</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Parallel&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percentage of data (Total size = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/blending-stacking_94_0.svg" src="../../_images/blending-stacking_94_0.svg" /></div>
</div>
<p>Training times seem to be linear in dataset size. We observe an improvement in training time with parallel processing by a fixed factor. Note that there is negligible overhead with parallelization and significant speedup of more than 1.5x!</p>
</div>
<div class="section" id="results-with-four-levels">
<h3>Results with four levels<a class="headerlink" href="#results-with-four-levels" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">update_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">parallel</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;xgb_pll_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blender_rk_pll_1&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lr_0</th>
      <th>lr_cnt_0</th>
      <th>rf_svd_0</th>
      <th>xgb_1</th>
      <th>blender_1</th>
      <th>blender_rk_1</th>
      <th>blender_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>cv_roc</th>
      <td>0.9322 ± 0.0038</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.8782 ± 0.0034</td>
      <td>0.9439 ± 0.0038</td>
      <td>0.9485 ± 0.0038</td>
      <td>0.9493 ± 0.0038</td>
      <td>0.9488 ± 0.0038</td>
    </tr>
    <tr>
      <th>cv_acc</th>
      <td>0.8565 ± 0.0036</td>
      <td>0.8786 ± 0.0047</td>
      <td>0.7978 ± 0.0011</td>
      <td>0.8778 ± 0.0035</td>
      <td>0.8687 ± 0.0101</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>test_roc</th>
      <td>0.9404</td>
      <td>0.9473</td>
      <td>0.8794</td>
      <td>0.9498</td>
      <td>0.9538</td>
      <td>0.9537</td>
      <td>0.9543</td>
    </tr>
    <tr>
      <th>test_acc</th>
      <td>0.871</td>
      <td>0.8838</td>
      <td>0.7976</td>
      <td>0.886</td>
      <td>0.8794</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This deep stack still looks good with good CV score and best test AUC score. Note that this improves upon the previous blending solution.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/fundamentals"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="pipelines.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Modelling with Pipelines</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="optuna.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Hyperparameter Optimization using Optuna</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By 𝗥𝗼𝗻 𝗠𝗲𝗱𝗶𝗻𝗮. Powered by <a href="https://jupyterbook.org">Jupyter Book</a>.<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>