
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Deployment &#8212; 𝗜𝗻𝗲𝗳𝗳𝗶𝗰𝗶𝗲𝗻𝘁 𝗡𝗲𝘁𝘄𝗼𝗿𝗸𝘀</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet">
  <link href="../../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/pone.0237978.g001.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Model Monitoring" href="../05-monitoring/notes.html" />
    <link rel="prev" title="Orchestration and ML Pipelines" href="../03-prefect/notes.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/pone.0237978.g001.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">𝗜𝗻𝗲𝗳𝗳𝗶𝗰𝗶𝗲𝗻𝘁 𝗡𝗲𝘁𝘄𝗼𝗿𝗸𝘀</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MLOPS ZOOMCAMP
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../01-intro/notes.html">
   Preliminaries
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02-mlflow/notes.html">
   Experiment Tracking and Model Management
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../03-prefect/notes.html">
   Orchestration and ML Pipelines
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Model Deployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05-monitoring/notes.html">
   Model Monitoring
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../06-best-practices/notes.html">
   Best practices
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  MODEL DEPLOYMENT
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../deployment/production-code.html">
   Packaging Production Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../deployment/model-serving-api.html">
   Prediction Serving API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../deployment/docker.html">
   Containerization with Docker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../deployment/cicd-pipelines.html">
   Continuous Integration and Deployment Pipelines
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  FUNDAMENTALS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fundamentals/pipelines.html">
   Modelling with Pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fundamentals/blending-stacking.html">
   Blending and Stacking
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fundamentals/optuna.html">
   Hyperparameter Optimization using Optuna
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fundamentals/missing.html">
   Handling Missing Values
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DEEP LEARNING
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../fundamentals/backpropagation.html">
   Backpropagation on DAGs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/01-tensorflow-nn.html">
   TensorFlow Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/02-tensorflow-mechanics.html">
   Mechanics of TensorFlow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/03-tensorflow-activations.html">
   Activation Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/04-tensorflow-optim-init.html">
   Initialization and Optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/05-tensorflow-cnn.html">
   Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tensorflow/06-tensorflow-rnns.html">
   Recurrent Neural Networks
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/notebooks/mlops/04-deployment/notes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/particle1331/inefficient-networks"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/particle1331/inefficient-networks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/mlops/04-deployment/notes.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-models-with-flask-and-docker">
   Deploying models with Flask and Docker
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#packaging-modeling-code">
     Packaging modeling code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-the-environment-with-pipenv">
     Setting up the environment with Pipenv
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#package-modules">
     Package modules
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-and-upload">
     Build and upload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#serving-predictions-using-flask">
     Serving predictions using Flask
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#containerizing-the-application-with-docker">
     Containerizing the application with Docker
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-deploying-models-with-kinesis-and-lambda">
   Streaming: Deploying models with Kinesis and Lambda
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-an-iam-role">
     Creating an IAM Role
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-lambda-function">
     Creating a Lambda function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reading-input-a-kinesis-data-stream">
     Reading input a Kinesis data stream
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#writing-predictions-to-a-kinesis-data-stream">
     Writing predictions to a Kinesis data stream
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#serving-the-model-as-a-container-with-ecr">
     Serving the model as a container with ECR
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#function-definition">
       Function definition
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dockerfile">
       Dockerfile
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#environmental-variables">
       Environmental variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#testing">
       Testing
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#publishing-to-ecr">
       Publishing to ECR
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#creating-the-lambda-function">
       Creating the lambda function
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-batch-predictions">
   Deploying batch predictions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batch-scoring">
     Batch scoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prefect-flow-for-batch-scoring">
     Prefect flow for batch scoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploying-the-batch-scoring-workflow-in-prefect">
     Deploying the batch scoring workflow in Prefect
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backfilling-or-predicting-on-previous-dates">
     Backfilling or predicting on previous dates
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-model-train-script">
   Appendix: Model train script
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Model Deployment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-models-with-flask-and-docker">
   Deploying models with Flask and Docker
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#packaging-modeling-code">
     Packaging modeling code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#setting-up-the-environment-with-pipenv">
     Setting up the environment with Pipenv
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#package-modules">
     Package modules
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#build-and-upload">
     Build and upload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#serving-predictions-using-flask">
     Serving predictions using Flask
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#containerizing-the-application-with-docker">
     Containerizing the application with Docker
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-deploying-models-with-kinesis-and-lambda">
   Streaming: Deploying models with Kinesis and Lambda
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-an-iam-role">
     Creating an IAM Role
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-a-lambda-function">
     Creating a Lambda function
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reading-input-a-kinesis-data-stream">
     Reading input a Kinesis data stream
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#writing-predictions-to-a-kinesis-data-stream">
     Writing predictions to a Kinesis data stream
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#serving-the-model-as-a-container-with-ecr">
     Serving the model as a container with ECR
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#function-definition">
       Function definition
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dockerfile">
       Dockerfile
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#environmental-variables">
       Environmental variables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#testing">
       Testing
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#publishing-to-ecr">
       Publishing to ECR
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#creating-the-lambda-function">
       Creating the lambda function
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploying-batch-predictions">
   Deploying batch predictions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#batch-scoring">
     Batch scoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prefect-flow-for-batch-scoring">
     Prefect flow for batch scoring
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deploying-the-batch-scoring-workflow-in-prefect">
     Deploying the batch scoring workflow in Prefect
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#backfilling-or-predicting-on-previous-dates">
     Backfilling or predicting on previous dates
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-model-train-script">
   Appendix: Model train script
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="model-deployment">
<h1>Model Deployment<a class="headerlink" href="#model-deployment" title="Permalink to this headline">¶</a></h1>
<p><img alt="Status" src="https://img.shields.io/static/v1.svg?label=Status&amp;message=Finished&amp;color=brightgreen" />
<a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/master/docs/notebooks/mlops/04-deployment"><img alt="Source" src="https://img.shields.io/static/v1.svg?label=GitHub&amp;message=Source&amp;color=181717&amp;logo=GitHub" /></a>
<a class="reference external" href="https://github.com/particle1331/inefficient-networks"><img alt="Stars" src="https://img.shields.io/github/stars/particle1331/inefficient-networks?style=social" /></a></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>𝗔𝘁𝘁𝗿𝗶𝗯𝘂𝘁𝗶𝗼𝗻: Notes for Module 4 of the MLOps Zoomcamp (2022) by DataTalks.Club.
</pre></div>
</div>
<hr class="docutils" />
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In this module, we will look into deploying the ride duration model which has been our working example in the modules. Deploying means that other applications can get predictions from our model. We will look at three modes of deployment: <strong>online</strong> deployment, <strong>offline</strong> or batch deployment, and <strong>streaming</strong>.</p>
<p>In online mode, our service must be up all the time. To do this, we implement a web service which takes in HTTP requests and sends out predictions. In offline or mode, we have a service running regularly, but not necessarily all the time. This can make predictions for a batch of examples that runs periodically using workflow orchestration. Finally, we look at how to implement a streaming service, i.e. a machine learning service that listens to a stream of events and reacts to it using AWS Kinesis and AWS Lambda.</p>
</div>
<div class="section" id="deploying-models-with-flask-and-docker">
<h2>Deploying models with Flask and Docker<a class="headerlink" href="#deploying-models-with-flask-and-docker" title="Permalink to this headline">¶</a></h2>
<p>In this section, we develop a web server using Flask for serving model predictions. The model is obtained from an S3 artifacts store and predicts on data sent to the service by the backend. We will containerize the application using Docker. This container can be deployed anywhere where Docker is supported such as Kubernetes and Elastic Beanstalk.</p>
<div class="section" id="packaging-modeling-code">
<h3>Packaging modeling code<a class="headerlink" href="#packaging-modeling-code" title="Permalink to this headline">¶</a></h3>
<p>We will collect code around our models into a <a class="reference external" href="https://pypi.org/project/ride-duration-prediction/"><code class="docutils literal notranslate"><span class="pre">ride_duration</span></code></a> package that will be uploaded to PyPI (hence can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span></code>). Having a model package ensures smooth integration with the Flask API since we have the same code for training, testing, and inference. Ideally, we should also use the same environment for each of these phases and this can be done by using <a class="reference external" href="https://pipenv.pypa.io/en/latest/">Pipenv</a>.</p>
<p>Also, packaging makes imports just work. For consistency, we will also use this package for our batch scoring workflow. The directory structure of our project would look like the following. Notice the nice separation between model code, application code, and deployment code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>deployment/
├── app/
│   └── main.py
├── ride_duration/
│   ├── __init__.py
│   ├── predict.py
│   ├── utils.py
│   └── VERSION
├── .env
├── Dockerfile
├── Pipfile
├── MANIFEST.in
├── Pipfile.lock
├── setup.py
├── test.py
├── train.py
└── pyproject.toml
</pre></div>
</div>
<p>First we create <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> for packaging. For the <code class="docutils literal notranslate"><span class="pre">setup</span></code> module, we only have to change the package metadata. Setting <code class="docutils literal notranslate"><span class="pre">REQUIRES_PYTHON</span></code> to <code class="docutils literal notranslate"><span class="pre">~=3.9.0</span></code> since some packages do not work with the latest version. All imports made in the module scripts are gathered in <code class="docutils literal notranslate"><span class="pre">INSTALL_REQUIRES</span></code> which contains abstract requirements minimally needed to run the package. This is <a class="reference external" href="https://packaging.python.org/en/latest/discussions/install-requires-vs-requirements/#requirements-files">a bit different</a> from a requirements file which lists pinned versions for the purpose of achieving repeatable installations of a complete environment.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/setup.py#L5-L24"><code class="docutils literal notranslate"><span class="pre">setup.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Package meta-data.</span>
<span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;ride-duration-prediction&quot;</span>
<span class="n">PACKAGE_NAME</span> <span class="o">=</span> <span class="s2">&quot;ride_duration&quot;</span>
<span class="n">DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;Predicting ride duration for TLC Trip Record Data.&quot;</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;https://particle1331.github.io/inefficient-networks/notebooks/mlops/04-deployment/notes.html&quot;</span>
<span class="n">EMAIL</span> <span class="o">=</span> <span class="s2">&quot;particle1331@gmail.com&quot;</span>
<span class="n">AUTHOR</span> <span class="o">=</span> <span class="s2">&quot;Ron Medina&quot;</span>
<span class="n">REQUIRES_PYTHON</span> <span class="o">=</span> <span class="s2">&quot;&gt;=3.9.0,&lt;3.10&quot;</span>
<span class="n">INSTALL_REQUIRES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;scikit-learn==1.0.2&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;mlflow&gt;=1.26.1,&lt;1.27.0&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;pandas&gt;=1.4.3,&lt;1.5.0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;joblib&gt;=1.1.0,&lt;1.2.0&quot;</span>
<span class="p">]</span>
<span class="n">LICENSE</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>
<span class="n">TROVE_CLASSIFIERS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Full list: https://pypi.python.org/pypi?%3Aaction=list_classifiers</span>
    <span class="s2">&quot;License :: OSI Approved :: MIT License&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Programming Language :: Python :: 3.9&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The other one just specifies the build system to use:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/pyproject.toml"><code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">build</span><span class="o">-</span><span class="n">system</span><span class="p">]</span>
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;setuptools&gt;=42.0&quot;</span><span class="p">,</span> <span class="s2">&quot;wheel&quot;</span><span class="p">]</span>
<span class="n">build</span><span class="o">-</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;setuptools.build_meta&quot;</span>
</pre></div>
</div>
<p>Additionally we include <a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/217134c84bb323452bf0dc3e8b6a6a04fea8f06b/docs/notebooks/mlops/04-deployment/MANIFEST.in"><code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code></a> file to specify the files included in the source distribution of the package. The full list can be viewed in the <code class="docutils literal notranslate"><span class="pre">SOURCES.txt</span></code> file of the generated <code class="docutils literal notranslate"><span class="pre">egg-info</span></code> folder after package build.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/MANIFEST.in"><code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code></a></p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="n">ride_duration</span><span class="o">/*.</span><span class="n">py</span>
<span class="n">include</span> <span class="n">ride_duration</span><span class="o">/</span><span class="n">VERSION</span>

<span class="n">recursive</span><span class="o">-</span><span class="n">exclude</span> <span class="o">*</span> <span class="n">__pycache__</span>
<span class="n">recursive</span><span class="o">-</span><span class="n">exclude</span> <span class="o">*</span> <span class="o">*.</span><span class="n">py</span><span class="p">[</span><span class="n">co</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-environment-with-pipenv">
<h3>Setting up the environment with Pipenv<a class="headerlink" href="#setting-up-the-environment-with-pipenv" title="Permalink to this headline">¶</a></h3>
<p>For dependency management, we will use <a class="reference external" href="https://pipenv.pypa.io/en/latest/">Pipenv</a>. Here we specify the path to the Python interpreter that the Pipenv environment will use. Recall that an easy way of installing specific versions of Python is through <code class="docutils literal notranslate"><span class="pre">conda</span></code> so we use that:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>base<span class="o">)</span> ubuntu@ip-172-31-24-183:~$ conda activate py39
<span class="o">(</span>py39<span class="o">)</span> ubuntu@ip-172-31-24-183:~$ which python
/home/ubuntu/anaconda3/envs/py39/bin/python
</pre></div>
</div>
<p>Deactivate the <code class="docutils literal notranslate"><span class="pre">conda</span></code> environment and navigate to the project root folder. Pointing to this path when activating the environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipenv shell --python<span class="o">=</span>/home/ubuntu/anaconda3/envs/py39/bin/python
</pre></div>
</div>
<p>This generates a <code class="docutils literal notranslate"><span class="pre">Pipfile</span></code> which supersedes the usual requirements file and also a <code class="docutils literal notranslate"><span class="pre">Pipfile.lock</span></code> containing hashes of downloaded packages that ensure reproducible builds. Another method is to call <code class="docutils literal notranslate"><span class="pre">pipenv</span> <span class="pre">install</span></code> on a folder with an existing valid <code class="docutils literal notranslate"><span class="pre">Pipfile</span></code>. To exit the virtual environment, we simply call <code class="docutils literal notranslate"><span class="pre">exit</span></code>.</p>
<p><strong>Dependencies.</strong> Pipenv automatically updates the <code class="docutils literal notranslate"><span class="pre">Pipfile</span></code> when installing dependencies:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipenv install scikit-learn<span class="o">==</span><span class="m">1</span>.0.2 flask pandas mlflow boto3 
</pre></div>
</div>
<p><strong>Dev dependencies.</strong> Installing the local model package and other development dependencies:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipenv install --dev -e .
pipenv install --dev requests
</pre></div>
</div>
<p><strong>Jupyter.</strong> To make this available as a kernel in Jupyter notebook or VS Code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipenv install --dev jupyter notebook
pipenv run python -m ipykernel install --user --name<span class="o">=</span><span class="sb">`</span>basename <span class="nv">$VIRTUAL_ENV</span><span class="sb">`</span>
</pre></div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">Pipfile</span></code> should now look as follows. Note that <code class="docutils literal notranslate"><span class="pre">ride-duration-prediction</span></code> is installed in editable mode since the package code is still in development (just so imports work everywhere).</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[[source]]</span><span class="w"></span>
<span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://pypi.org/simple&quot;</span><span class="w"></span>
<span class="na">verify_ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span><span class="w"></span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pypi&quot;</span><span class="w"></span>

<span class="k">[packages]</span><span class="w"></span>
<span class="na">scikit-learn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;==1.0.2&quot;</span><span class="w"></span>
<span class="na">flask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">pandas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">mlflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">boto3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>

<span class="k">[dev-packages]</span><span class="w"></span>
<span class="na">ride-duration-prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">{editable = true, path = &quot;.&quot;}</span><span class="w"></span>
<span class="na">jupyter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">notebook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>

<span class="k">[requires]</span><span class="w"></span>
<span class="na">python_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;3.9&quot;</span><span class="w"></span>
</pre></div>
</div>
<p><strong>Secrets.</strong> AWS credentials and other environmental variables are saved in a <code class="docutils literal notranslate"><span class="pre">.env</span></code> file in the same directory as Pipfile. These are automatically detected and loaded by Pipenv when calling <code class="docutils literal notranslate"><span class="pre">pipenv</span> <span class="pre">shell</span></code>. But the shell must be restarted whenever the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file is modified to load the changes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># .env</span>
<span class="nv">EXPERIMENT_ID</span><span class="o">=</span><span class="m">1</span>
<span class="nv">RUN_ID</span><span class="o">=</span>f4e2242a53a3410d89c061d1958ae70a
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>A*************LI
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>N*********************+9
</pre></div>
</div>
</div>
<div class="section" id="package-modules">
<h3>Package modules<a class="headerlink" href="#package-modules" title="Permalink to this headline">¶</a></h3>
<p>In the following module, define helper functions for model training and inference. This includes the usual <code class="docutils literal notranslate"><span class="pre">load_training_dataframe</span></code> function which creates the target features (ride duration in minutes) and filters it to some range, i.e. <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">60]</span></code>. This function is used for creating training and validation datasets. The other function <code class="docutils literal notranslate"><span class="pre">prepare_features</span></code> is used for feature engineering.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/ride_duration/utils.py#L16-L37"><code class="docutils literal notranslate"><span class="pre">utils.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_training_dataframe</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">y_min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_max</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load data from disk and preprocess for training.&quot;&quot;&quot;</span>
    
    <span class="c1"># Load data from disk</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># Create target column and filter outliers</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">lpep_dropoff_datetime</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">lpep_pickup_datetime</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">prepare_features</span><span class="p">(</span><span class="n">input_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Prepare features for dict vectorizer.&quot;&quot;&quot;</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PU_DO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;PULocationID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;DOLocationID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="s1">&#39;PU_DO&#39;</span><span class="p">,</span> <span class="s1">&#39;trip_distance&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">X</span>
</pre></div>
</div>
<p>Next we look at the <code class="docutils literal notranslate"><span class="pre">predict</span></code> module of our package. This contains two functions: one for loading the model and another for making predictions with the model. The <code class="docutils literal notranslate"><span class="pre">load_model</span></code> function loads a model directly from the S3 artifacts store:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/ride_duration/predict.py#L10-L16"><code class="docutils literal notranslate"><span class="pre">predict.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get model from our S3 artifacts store.&quot;&quot;&quot;</span>

    <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;s3://mlflow-models-ron/</span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/artifacts/model&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<p>To avoid having to load the preprocessor separately from the artifacts store, we train models that are pipelines of the following form (see <strong>Appendix</strong> below):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">DictVectorizer</span><span class="p">(),</span> 
    <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Our models expect as input <code class="docutils literal notranslate"><span class="pre">prepare_features(data)</span></code> where <code class="docutils literal notranslate"><span class="pre">data</span></code> can be a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with rows containing ride or a list of ride features dictionaries (e.g obtained as a JSON payload). So we define the following function to help with inference:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/ride_duration/predict.py#L19-L25"><code class="docutils literal notranslate"><span class="pre">predict.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Make prediction from features dict or DataFrame.&quot;&quot;&quot;</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preds</span>
</pre></div>
</div>
<p>Testing out the <code class="docutils literal notranslate"><span class="pre">load_model()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ride_duration.predict</span> <span class="kn">import</span> <span class="n">load_model</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXPERIMENT_ID&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RUN_ID&quot;</span><span class="p">))</span>
<span class="n">model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mlflow.pyfunc.loaded_model:
  artifact_path: model
  flavor: mlflow.sklearn
  run_id: f4e2242a53a3410d89c061d1958ae70a
</pre></div>
</div>
</div>
</div>
<br><div class="figure align-default" id="id2">
<img alt="../../../_images/s3-artifacts-ss.png" src="../../../_images/s3-artifacts-ss.png" />
<p class="caption"><span class="caption-number">Fig. 20 </span><span class="caption-text">Artifacts store for model runs of experiment 1.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>As an alternative, we can also load the latest <strong>production version</strong> directly from the model registry (no need to specify a run and experiment ID) using the tracking server. One issue is that starting of the Flask server can fail whenever the request the tracking server is down.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TRACKING_URI</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">TRACKING_SERVER_HOST</span><span class="si">}</span><span class="s2">:5000&quot;</span>

<span class="c1"># Fetch production model from client</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">TRACKING_URI</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">MlflowClient</span><span class="p">(</span><span class="n">tracking_uri</span><span class="o">=</span><span class="n">TRACKING_URI</span><span class="p">)</span>
<span class="n">prod_model</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_latest_versions</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;NYCRideDurationModel&#39;</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Production&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Load model from S3 artifacts store</span>
<span class="n">run_id</span> <span class="o">=</span> <span class="n">prod_model</span><span class="o">.</span><span class="n">run_id</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">prod_model</span><span class="o">.</span><span class="n">source</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">pyfunc</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="build-and-upload">
<h3>Build and upload<a class="headerlink" href="#build-and-upload" title="Permalink to this headline">¶</a></h3>
<p>Once we are satisfied with the model package, we can now upload it to PyPI.</p>
<p>Building the package and uploading to PyPI:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipenv install --dev build
pipenv install --dev twine
pipenv run python -m build
<span class="nb">export</span> <span class="nv">USERNAME</span><span class="o">=</span>particle1331
<span class="nb">export</span> <span class="nv">PASSWORD</span><span class="o">=</span>************
pipenv run python -m twine upload -u <span class="nv">$USERNAME</span> -p <span class="nv">$PASSWORD</span> dist/*
</pre></div>
</div>
<p>Uploaded package can be viewed <a class="reference external" href="https://pypi.org/project/ride-duration-prediction/0.1.0/">here</a>. Properly installing the package as a dependency:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>pipenv uninstall --dev -e .
pipenv install ride-duration-prediction==0.3.0
</pre></div>
</div>
<p>Final <code class="docutils literal notranslate"><span class="pre">Pipfile</span></code> should look like:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/23aaa1ff9fee905e5e3e6a44cd141a41dfa5e5a3/docs/notebooks/mlops/04-deployment/Pipfile#L1-L26"><code class="docutils literal notranslate"><span class="pre">Pipfile</span></code></a></p>
</div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[[source]]</span><span class="w"></span>
<span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://pypi.org/simple&quot;</span><span class="w"></span>
<span class="na">verify_ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span><span class="w"></span>
<span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;pypi&quot;</span><span class="w"></span>

<span class="k">[packages]</span><span class="w"></span>
<span class="na">scikit-learn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;==1.0.2&quot;</span><span class="w"></span>
<span class="na">flask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">pandas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">mlflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">boto3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">ride-duration-prediction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;==0.3.0&quot;</span><span class="w"></span>
<span class="na">prefect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;==2.0b5&quot;</span><span class="w"></span>
<span class="na">python-dotenv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">pyarrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>

<span class="k">[dev-packages]</span><span class="w"></span>
<span class="na">jupyter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">notebook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">twine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<span class="na">build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>

<span class="k">[requires]</span><span class="w"></span>
<span class="na">python_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;3.9&quot;</span><span class="w"></span>
</pre></div>
</div>
<br><div class="figure align-default" id="id3">
<a class="reference internal image-reference" href="../../../_images/pypi.png"><img alt="../../../_images/pypi.png" src="../../../_images/pypi.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 21 </span><span class="caption-text">Our model package in the Python package index. 🐍</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="serving-predictions-using-flask">
<h3>Serving predictions using Flask<a class="headerlink" href="#serving-predictions-using-flask" title="Permalink to this headline">¶</a></h3>
<p>The model loads when the Flask server starts. The server exposes a single endpoint defined by <code class="docutils literal notranslate"><span class="pre">predict_endpoint</span></code> which expects a singleton JSON payload of ride features from the backend. For observability, each prediction is returned along with the <code class="docutils literal notranslate"><span class="pre">run_id</span></code> of the model.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/app/main.py"><code class="docutils literal notranslate"><span class="pre">app/main.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">ride_duration.predict</span> <span class="kn">import</span> <span class="n">load_model</span><span class="p">,</span> <span class="n">make_prediction</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>


<span class="c1"># Load model with run ID and experiment ID defined in the env.</span>
<span class="n">RUN_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RUN_ID&quot;</span><span class="p">)</span>
<span class="n">EXPERIMENT_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXPERIMENT_ID&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">RUN_ID</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="n">EXPERIMENT_ID</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s1">&#39;duration-prediction&#39;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">predict_endpoint</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Predict duration of a single ride using NYCRideDurationModel.&quot;&quot;&quot;</span>
    
    <span class="n">ride</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">make_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">[</span><span class="n">ride</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="s1">&#39;model_version&#39;</span><span class="p">:</span> <span class="n">RUN_ID</span><span class="p">,</span>
    <span class="p">})</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">9696</span><span class="p">)</span>
</pre></div>
</div>
<p>For testing the prediction endpoint, we have the following script. This can be used without modification to test remote hosts using port forwarding.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/test.py"><code class="docutils literal notranslate"><span class="pre">test.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="n">ride</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PULocationID&quot;</span><span class="p">:</span> <span class="mi">130</span><span class="p">,</span>
    <span class="s2">&quot;DOLocationID&quot;</span><span class="p">:</span> <span class="mi">205</span><span class="p">,</span>
    <span class="s2">&quot;trip_distance&quot;</span><span class="p">:</span> <span class="mf">3.66</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://0.0.0.0:9696&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/predict&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">ride</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="containerizing-the-application-with-docker">
<h3>Containerizing the application with Docker<a class="headerlink" href="#containerizing-the-application-with-docker" title="Permalink to this headline">¶</a></h3>
<p>For our <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code>, we start by installing Pipenv. Then, we copy all files relevant for running the application. So these are the requirements files, the model package files, and the files for the Flask app. Next, we install everything using Pipenv, expose the <code class="docutils literal notranslate"><span class="pre">9696</span></code> endpoint, and configure the entrypoint which serves the main app on <code class="docutils literal notranslate"><span class="pre">0.0.0.0:9696</span></code>.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/dee935715209f55ac833ec6c0067a43ded9629d9/docs/notebooks/mlops/04-deployment/Dockerfile"><code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></a></p>
</div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.13-slim</span>

<span class="k">RUN</span><span class="w"> </span>pip install -U pip
<span class="k">RUN</span><span class="w"> </span>pip install pipenv

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">COPY</span><span class="w"> </span><span class="o">[</span> <span class="s2">&quot;Pipfile&quot;</span>, <span class="s2">&quot;Pipfile.lock&quot;</span>,  <span class="s2">&quot;./&quot;</span><span class="o">]</span>
<span class="k">COPY</span><span class="w"> </span><span class="o">[</span> <span class="s2">&quot;app&quot;</span>,  <span class="s2">&quot;./app&quot;</span><span class="o">]</span>

<span class="k">RUN</span><span class="w"> </span>pipenv install --system --deploy

<span class="k">EXPOSE</span><span class="w"> </span><span class="s">9696</span>

<span class="c"># https://stackoverflow.com/a/71092624/1091950</span>
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;gunicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--bind=0.0.0.0:9696&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--timeout=600&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;app.main:app&quot;</span><span class="w"> </span><span class="p">]</span>
</pre></div>
</div>
<p>Building the image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker build -t ride-duration-prediction-service:v1 .
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>+<span class="o">]</span> Building <span class="m">177</span>.1s <span class="o">(</span><span class="m">12</span>/12<span class="o">)</span> <span class="nv">FINISHED</span>
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build definition from Docke  <span class="m">0</span>.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring dockerfile: 376B             <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load .dockerignore                <span class="m">0</span>.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: 2B                  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load metadata <span class="k">for</span> docker.io/libr  <span class="m">4</span>.9s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">1</span>/7<span class="o">]</span> FROM docker.io/library/python:3.9.13  <span class="m">22</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; resolve docker.io/library/python:3.9.13-  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:278d211701f68 <span class="m">858</span>.90kB / <span class="m">858</span>.90kB  <span class="m">3</span>.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:94b65918aca5f4b <span class="m">11</span>.59MB / <span class="m">11</span>.59MB  <span class="m">7</span>.6s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:c01a2db78654c1923 <span class="m">1</span>.86kB / <span class="m">1</span>.86kB  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:ef78109875ac0ac47 <span class="m">1</span>.37kB / <span class="m">1</span>.37kB  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:ddaaa6b80b0541f48 <span class="m">7</span>.50kB / <span class="m">7</span>.50kB  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:3b157c852f2736 <span class="m">30</span>.07MB / <span class="m">30</span>.07MB  <span class="m">15</span>.8s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:0f660d3f04731206fb1e8 234B / 234B  <span class="m">3</span>.9s0
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; sha256:2b5c279a2d3443d3a <span class="m">2</span>.95MB / <span class="m">2</span>.95MB  <span class="m">8</span>.6s0
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; extracting sha256:3b157c852f2736e12f0904  <span class="m">3</span>.4s0
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; extracting sha256:278d211701f6882403e47f  <span class="m">0</span>.3s0
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; extracting sha256:94b65918aca5f4bc0654e6  <span class="m">0</span>.9s0
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; extracting sha256:0f660d3f04731206fb1e8b  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; extracting sha256:2b5c279a2d3443d3ab6534  <span class="m">0</span>.5s
 <span class="o">=</span>&gt; <span class="o">[</span>internal<span class="o">]</span> load build context                <span class="m">0</span>.1s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; transferring context: <span class="m">96</span>.05kB             <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">2</span>/7<span class="o">]</span> RUN pip install -U pip                 <span class="m">5</span>.7s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">3</span>/7<span class="o">]</span> RUN pip install pipenv                <span class="m">14</span>.1s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">4</span>/7<span class="o">]</span> WORKDIR /app                           <span class="m">0</span>.1s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">5</span>/7<span class="o">]</span> COPY <span class="o">[</span> Pipfile, Pipfile.lock,  ./<span class="o">]</span>     <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">6</span>/7<span class="o">]</span> COPY <span class="o">[</span> app,  ./app<span class="o">]</span>                    <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">[</span><span class="m">7</span>/7<span class="o">]</span> RUN pipenv install --system --deplo  <span class="m">106</span>.1s
 <span class="o">=</span>&gt; exporting to image                          <span class="m">23</span>.7s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; exporting layers                         <span class="m">23</span>.4s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; writing image sha256:f92279e7eb9164ba32e  <span class="m">0</span>.0s
 <span class="o">=</span>&gt; <span class="o">=</span>&gt; naming to docker.io/library/ride-duratio  <span class="m">0</span>.0s
</pre></div>
</div>
<p>Running the container with variables in <code class="docutils literal notranslate"><span class="pre">.env</span></code> loaded as environmental variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run --env-file .env -it --rm -p <span class="m">9696</span>:9696 ride-duration-prediction-service:v1
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[2022-06-25 23:51:36 +0000] [1] [INFO] Starting gunicorn 20.1.0
[2022-06-25 23:51:36 +0000] [1] [INFO] Listening at: http://0.0.0.0:9696 (1)
[2022-06-25 23:51:36 +0000] [1] [INFO] Using worker: sync
[2022-06-25 23:51:36 +0000] [7] [INFO] Booting worker with pid: 7
</pre></div>
</div>
<p>Testing prediction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python test.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;duration&#39;: 18.210770674183355, &#39;model_version&#39;: &#39;f4e2242a53a3410d89c061d1958ae70a&#39;}
</pre></div>
</div>
</div>
</div>
<p>Note that after the initial loading time the next predictions are returned instantaneously. This confirms that the model is loaded only once when the server starts.</p>
</div>
</div>
<div class="section" id="streaming-deploying-models-with-kinesis-and-lambda">
<h2>Streaming: Deploying models with Kinesis and Lambda<a class="headerlink" href="#streaming-deploying-models-with-kinesis-and-lambda" title="Permalink to this headline">¶</a></h2>
<p>A streaming service consists of <strong>producers</strong> and <strong>consumers</strong>. Producers push events to the event stream which are consumed by consuming services that react to this stream. Recall that a web service exhibits a 1-1 relationship so that there is explicit connection between user and service. On the other hand, the relationship between producing and consuming services can be 1-many or many-many. There is only implicit connection since we don’t know which consumers will react or how many. Streaming services can be scaled to many services or models.</p>
<p>For example, when a user uses our ride hailing app, the backend can send an event to the stream containing all information about this ride. Then services will react on this event, e.g. one consuming service predicts tip and sends a push notification to user asking for the tip. And consuming services which makes better ride duration prediction but takes more time to make a prediction can update the prediction that was initially given to the user by the online web service.</p>
<div class="figure align-default" id="id4">
<img alt="../../../_images/lambda.png" src="../../../_images/lambda.png" />
<p class="caption"><span class="caption-number">Fig. 22 </span><span class="caption-text"><strong>Streaming service that we develop in this section.</strong> A production model is pulled from S3 and served as a function in AWS Lambda. This function reads on the ride events stream and writes on the ride predictions stream. Some elements around this system that can be present in actual production systems are in dashed outlines. For example, a Python microservice is shown that reads and writes on the same streams as our Lambda function.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="creating-an-iam-role">
<h3>Creating an IAM Role<a class="headerlink" href="#creating-an-iam-role" title="Permalink to this headline">¶</a></h3>
<p>To create a serverless function for serving our model, we will use <a class="reference external" href="https://aws.amazon.com/lambda/">AWS Lambda</a>. The advantage of this is that we do not have to worry about owning a server that runs our function, we just know that the function is being executed somewhere in AWS. For the sake of demonstration, we will pretend that we are serving better model predictions, although we are actually deploying the same Random Forest model.</p>
<p><strong>Steps</strong></p>
<ol>
<li><p>Open the roles page in the IAM console and choose <strong>Create role</strong>. Choose Lambda as trusted entity type.</p>
<div class="figure align-default">
<img alt="../../../_images/create-role.png" src="../../../_images/create-role.png" />
</div>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">AWSLambdaKinesisExecutionRole</span></code> to permissions. This role can read from Kinesis streams and write logs. Resource <code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> means that the role can do this to <em>any</em> Kinesis stream or log group. So this takes care of reading from input streams for our functions.</p>
<div class="figure align-default">
<img alt="../../../_images/create-role-2.png" src="../../../_images/create-role-2.png" />
</div>
</li>
<li><p>Set name to <code class="docutils literal notranslate"><span class="pre">lambda-kinesis-role</span></code> and proceed to create role.</p>
<div class="figure align-default">
<img alt="../../../_images/create-role-3.png" src="../../../_images/create-role-3.png" />
</div>
</li>
<li><p>Next we will give read permissions to S3. This is because our Lambda function will get its machine learning model from the MLflow artifacts store in S3. Select the <code class="docutils literal notranslate"><span class="pre">lambda-kinesis-role</span></code>, then select <strong>Add permissions</strong> &gt; <strong>Attach policies</strong> &gt; <strong>Create policy</strong>. Switch to the editor’s JSON tab and paste:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;s3:Get*&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;s3:List*&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;arn:aws:s3:::mlflow-models-ron&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;arn:aws:s3:::mlflow-models-ron/*&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">mlflow-models-ron</span></code> is the name of the artifacts store in S3. From this JSON, we can read that this policy allows all <code class="docutils literal notranslate"><span class="pre">Get</span></code> and all <code class="docutils literal notranslate"><span class="pre">List</span></code> actions on our <code class="docutils literal notranslate"><span class="pre">mlflow-models-ron</span></code> S3 bucket and its subdirectories. Skip tags, set name to be <code class="docutils literal notranslate"><span class="pre">read_premission_mlflow-models-ron</span></code>, put in the appropriate description, then select <strong>Create policy</strong>. Make sure to attach this policy to <code class="docutils literal notranslate"><span class="pre">lambda-kinesis-role</span></code>.
<br> <br></p>
</li>
<li><p>Finally, our Lambda functions have to write to output data streams. Do the same as above and create and attach a policy to <code class="docutils literal notranslate"><span class="pre">lambda-kinesis-role</span></code>. In this case, paste the following JSON, and name the policy <code class="docutils literal notranslate"><span class="pre">lambda_kinesis_write_to_ride_predictions</span></code>.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Statement&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;kinesis:PutRecord&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="s2">&quot;kinesis:PutRecords&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:kinesis:us-east-1:241297376613:stream/ride_predictions&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This defines permissions for writing on the <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code> data stream (which does not exist yet). Here <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code> is the region and <code class="docutils literal notranslate"><span class="pre">241297376613</span></code> is the IAM Account ID. Note that all streams and functions must live on the same region for them to work together. The allowed actions are <code class="docutils literal notranslate"><span class="pre">PutRecord</span></code> for an API call that puts a single record on the stream, and <code class="docutils literal notranslate"><span class="pre">PutRecords</span></code> for an API call that puts a batch of records on the stream.</p>
</li>
</ol>
<br><div class="figure align-default" id="id5">
<img alt="../../../_images/lambda-kinesis-policies.png" src="../../../_images/lambda-kinesis-policies.png" />
<p class="caption"><span class="caption-number">Fig. 23 </span><span class="caption-text">The <code class="docutils literal notranslate"><span class="pre">lambda-kinesis-role</span></code> for our Lambda function with policies for reading from all Kinesis data streams, writing on <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code> Kinesis data stream, and getting models from the <code class="docutils literal notranslate"><span class="pre">mlflow-models-ron</span></code> bucket in S3.</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="creating-a-lambda-function">
<h3>Creating a Lambda function<a class="headerlink" href="#creating-a-lambda-function" title="Permalink to this headline">¶</a></h3>
<p>Go to Lambda and create <code class="docutils literal notranslate"><span class="pre">ride-duration-prediction-test</span></code> for testing. Later we will create the actual function. In the permissions, choose the role that we have just created.</p>
<div class="figure align-default">
<img alt="../../../_images/create-function.png" src="../../../_images/create-function.png" />
</div>
<div class="figure align-default" id="id6">
<img alt="../../../_images/create-function-2.png" src="../../../_images/create-function-2.png" />
<p class="caption"><span class="caption-number">Fig. 24 </span><span class="caption-text">The <code class="docutils literal notranslate"><span class="pre">ride-duration-prediction-test</span></code> function.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<p>Let’s modify this to look more like our machine learning function. Note that unlike for a web service, there is no 1-1 relationship between inputs and outputs. We have to include a <code class="docutils literal notranslate"><span class="pre">ride_id</span></code> to tie an input event to its corresponding event in the output stream. In the code section write and deploy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lambda_function.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;PU_DO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;PULocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;DOLocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ride</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.0</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">ride</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;ride&#39;</span><span class="p">]</span>
    <span class="n">ride_id</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;ride_id&#39;</span><span class="p">]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;ride_duration&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
        <span class="s1">&#39;ride_id&#39;</span><span class="p">:</span> <span class="n">ride_id</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Configure the <strong>test event</strong> to:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><strong>Toy test event</strong></p>
</div>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;ride&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;PULocationID&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;DOLocationID&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">205</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;trip_distance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">3.66</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&quot;ride_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Running the test. The model predicts a constant <code class="docutils literal notranslate"><span class="pre">10</span></code> minutes for each ride:</p>
<div class="figure align-default">
<img alt="../../../_images/lambda-2.png" src="../../../_images/lambda-2.png" />
</div>
</div>
<div class="section" id="reading-input-a-kinesis-data-stream">
<h3>Reading input a Kinesis data stream<a class="headerlink" href="#reading-input-a-kinesis-data-stream" title="Permalink to this headline">¶</a></h3>
<p>In this section, we attach a Kinesis data stream to our function. Go to Kinesis to create a data stream. We will call it <code class="docutils literal notranslate"><span class="pre">ride_events</span></code> and set its capacity mode to <strong>Provisioned</strong> with 1 shard. AWS provides the write and read capacity for the chosen number of shards. Note that we have to pay per hour for each shard.</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../../_images/kinesis-stream-1.png"><img alt="../../../_images/kinesis-stream-1.png" src="../../../_images/kinesis-stream-1.png" style="width: 30em;" /></a>
</div>
<p>Going back to Lambda and add <code class="docutils literal notranslate"><span class="pre">ride_events</span></code> as trigger to the function:</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../../_images/kinesis-stream-2.png"><img alt="../../../_images/kinesis-stream-2.png" src="../../../_images/kinesis-stream-2.png" style="width: 30em;" /></a>
</div>
<p>Once the trigger is enabled, we execute the following the command line which puts a test event to the stream. Our lambda should read from the stream and we should see this in logs. We comment out our code, and only print out what a Kinesis event looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lambda_function.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;PU_DO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;PULocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;DOLocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ride</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">features</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.0</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>  
    <span class="n">event_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event_json</span><span class="p">)</span>

    <span class="c1"># ride = event[&#39;ride&#39;]</span>
    <span class="c1"># ride_id = event[&#39;ride_id&#39;]</span>

    <span class="c1"># features = prepare_features(ride)</span>
    <span class="c1"># prediction = predict(features)</span>

    <span class="c1"># return {</span>
    <span class="c1">#     &#39;ride_duration&#39;: prediction,</span>
    <span class="c1">#     &#39;ride_id&#39;: ride_id</span>
    <span class="c1"># }</span>
</pre></div>
</div>
<p>Putting the above test event into the input stream:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><strong>Put record</strong>
<br>
v. <code class="docutils literal notranslate"><span class="pre">aws-cli/1.22.34</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws kinesis put-record <span class="se">\</span>
    --stream-name ride_events <span class="se">\</span>
    --partition-key <span class="m">1</span> <span class="se">\</span>
    --data <span class="s1">&#39;{</span>
<span class="s1">        &quot;ride&quot;: {</span>
<span class="s1">            &quot;PULocationID&quot;: 130,</span>
<span class="s1">            &quot;DOLocationID&quot;: 205,</span>
<span class="s1">            &quot;trip_distance&quot;: 3.66</span>
<span class="s1">        },</span>
<span class="s1">        &quot;ride_id&quot;: 123</span>
<span class="s1">    }&#39;</span>
</pre></div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><code class="docutils literal notranslate"><span class="pre">[out]</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;ShardId&quot;</span>: <span class="s2">&quot;shardId-000000000000&quot;</span>,
    <span class="s2">&quot;SequenceNumber&quot;</span>: <span class="s2">&quot;49630706038424016596026506533783680704960320015674900482&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">SequenceNumber</span></code> of this event. This event can be found on the logs by looking at the “Monitor” tab of the lambda function and clicking on “View logs in CloudWatch”. We update the test event in the lambda function with this record. In particular, this means we don’t have to push events to the input stream when testing.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><strong>Actual test event</strong></p>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;Records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;kinesis&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;kinesisSchemaVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;partitionKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;sequenceNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;49630706038424016596026506533782471779140474214180454402&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;eyAgICAgICAgICAicmlkZSI6IHsgICAgICAgICAgICAgICJQVUxvY2F0aW9uSUQiOiAxMzAsICAgICAgICAgICAgICAiRE9Mb2NhdGlvbklEIjogMjA1LCAgICAgICAgICAgICAgInRyaXBfZGlzdGFuY2UiOiAzLjY2ICAgICAgICAgIH0sICAgICAgICAgICJyaWRlX2lkIjogMTIzICAgICAgfQ==&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="nt">&quot;approximateArrivalTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1655944485.718</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;eventSource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws:kinesis&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;eventID&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;shardId-000000000000:49630706038424016596026506533782471779140474214180454402&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;eventName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws:kinesis:record&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;invokeIdentityArn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::241297376613:role/lambda-kinesis-role&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:kinesis:us-east-1:241297376613:stream/ride_events&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<br><div class="figure align-default" id="id7">
<img alt="../../../_images/kinesis-stream-5.png" src="../../../_images/kinesis-stream-5.png" />
<p class="caption"><span class="caption-number">Fig. 25 </span><span class="caption-text">Record with sequence number <code class="docutils literal notranslate"><span class="pre">496...402</span></code> printed in the logs.</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<p>It turns out that Kinesis encodes event data in <code class="docutils literal notranslate"><span class="pre">base64</span></code>, i.e. as <code class="docutils literal notranslate"><span class="pre">&quot;data&quot;:</span> <span class="pre">&quot;eyAgI...&quot;</span></code>. So we have to decode this to be able to use it. Since the batch size is set to 100, we need to iterate over records to access each of them. Our function is modified as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lambda_function.py</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;kinesis&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">ride_event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>

        <span class="n">ride</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride&#39;</span><span class="p">]</span>
        <span class="n">ride_id</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride_id&#39;</span><span class="p">]</span>
    
        <span class="n">features</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ride_duration&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
            <span class="s1">&#39;ride_id&#39;</span><span class="p">:</span> <span class="n">ride_id</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>Executing on the Kinesis test event. Observe that the data has been properly decoded:</p>
<div class="figure align-default">
<img alt="../../../_images/kinesis-stream-6.png" src="../../../_images/kinesis-stream-6.png" />
</div>
</div>
<div class="section" id="writing-predictions-to-a-kinesis-data-stream">
<h3>Writing predictions to a Kinesis data stream<a class="headerlink" href="#writing-predictions-to-a-kinesis-data-stream" title="Permalink to this headline">¶</a></h3>
<p>In the previous section, we created an input data stream in Kinesis. Repeat the same process in Kinesis to create an output data stream called <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code>. Similarly set its capacity mode to <strong>Provisioned</strong> with 1 shard. Note that we already created write permission to this stream even before it was created. But you have to get the name correct.</p>
<p>To write onto an <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code>, we modify our lambda function as follows. Basically, we have a client version of the CLI command for putting records onto a data stream. So we have to connect to the Kinesis client using <code class="docutils literal notranslate"><span class="pre">boto3</span></code> and specify <code class="docutils literal notranslate"><span class="pre">PREDICTIONS_STREAM_NAME</span></code> which defaults to <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code> which has just been created. Paste the following in the code editor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lambda_function.py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">kinesis_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;kinesis&#39;</span><span class="p">)</span>
<span class="n">PREDICTIONS_STREAM_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PREDICTIONS_STREAM_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ride_predictions&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;PU_DO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;PULocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ride</span><span class="p">[</span><span class="s1">&#39;DOLocationID&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">features</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ride</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">features</span>
    
    
<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">10.0</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    
    <span class="n">prediction_events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;kinesis&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        
        <span class="n">ride_event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>
        <span class="n">ride</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride&#39;</span><span class="p">]</span>
        <span class="n">ride_id</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride_id&#39;</span><span class="p">]</span>
    
        <span class="n">features</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">ride</span><span class="p">)</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="n">prediction_event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;ride_duration_prediction_model&#39;</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ride_duration&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                <span class="s1">&#39;ride_id&#39;</span><span class="p">:</span> <span class="n">ride_id</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/kinesis.html#Kinesis.Client.put_record</span>
        <span class="n">kinesis_client</span><span class="o">.</span><span class="n">put_record</span><span class="p">(</span>
            <span class="n">StreamName</span><span class="o">=</span><span class="n">PREDICTIONS_STREAM_NAME</span><span class="p">,</span>
            <span class="n">Data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction_event</span><span class="p">),</span>
            <span class="n">PartitionKey</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ride_id</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">prediction_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction_event</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">prediction_events</span>
    <span class="p">}</span> 
</pre></div>
</div>
<p>Note that in applications multiple consumers can push data to this output stream, so we include <code class="docutils literal notranslate"><span class="pre">model</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code> in the output for the prediction event to be traceable to this model. Also <code class="docutils literal notranslate"><span class="pre">put_records</span></code> which can support up to 500 records is cheaper, since you pay for each API call. But to make the code simpler, we use <code class="docutils literal notranslate"><span class="pre">put_record</span></code>.</p>
<p>Testing this in the Lambda UI. If you fail to create the correct write permission you’ll get the following error during testing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;errorMessage&quot;</span><span class="p">:</span> <span class="s2">&quot;An error occurred (AccessDeniedException) when calling the PutRecord operation: User: arn:aws:sts::241297376613:assumed-role/lambda-kinesis-role/ride-duration-prediction-test is not authorized to perform: kinesis:PutRecord on resource: arn:aws:kinesis:us-east-1:241297376613:stream/ride_predictions because no identity-based policy allows the kinesis:PutRecord action&quot;</span><span class="o">...</span>
</pre></div>
</div>
<div class="figure align-default" id="id8">
<img alt="../../../_images/kinesis-out-stream-1.png" src="../../../_images/kinesis-out-stream-1.png" />
<p class="caption"><span class="caption-number">Fig. 26 </span><span class="caption-text">Test passed.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</div>
<p>Reading from output stream:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><strong>Get records</strong>
<br>
v. <code class="docutils literal notranslate"><span class="pre">aws-cli/1.22.34</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">KINESIS_STREAM_OUTPUT</span><span class="o">=</span><span class="s1">&#39;ride_predictions&#39;</span>
<span class="nv">SHARD</span><span class="o">=</span><span class="s1">&#39;shardId-000000000000&#39;</span>

<span class="nv">SHARD_ITERATOR</span><span class="o">=</span><span class="k">$(</span>aws kinesis <span class="se">\</span>
    get-shard-iterator <span class="se">\</span>
        --shard-id <span class="si">${</span><span class="nv">SHARD</span><span class="si">}</span> <span class="se">\</span>
        --shard-iterator-type TRIM_HORIZON <span class="se">\</span>
        --stream-name <span class="si">${</span><span class="nv">KINESIS_STREAM_OUTPUT</span><span class="si">}</span> <span class="se">\</span>
        --query <span class="s1">&#39;ShardIterator&#39;</span> <span class="se">\</span>
<span class="k">)</span>

<span class="nv">RESULT</span><span class="o">=</span><span class="k">$(</span>aws kinesis get-records --shard-iterator <span class="nv">$SHARD_ITERATOR</span><span class="k">)</span>

<span class="nb">echo</span> <span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span> <span class="p">|</span> jq -r <span class="s1">&#39;.Records[-1].Data&#39;</span> <span class="p">|</span> base64 --decode <span class="p">|</span> jq
</pre></div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><code class="docutils literal notranslate"><span class="pre">[out]</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
  <span class="s2">&quot;model&quot;</span>: <span class="s2">&quot;ride_duration_prediction_model&quot;</span>,
  <span class="s2">&quot;version&quot;</span>: <span class="m">123</span>,
  <span class="s2">&quot;prediction&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;ride_duration&quot;</span>: <span class="m">10</span>,
    <span class="s2">&quot;ride_id&quot;</span>: <span class="m">123</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Here we only have one shard. If we have multiple shards, we have to know which shard to read to. Shard iterator gives us an ID of an iterator, and that gives us a way to retrieve records from a stream. The command above is a bit complex, since we are reading without Lambda which hides all of these details under the hood.</p>
</div>
<div class="section" id="serving-the-model-as-a-container-with-ecr">
<h3>Serving the model as a container with ECR<a class="headerlink" href="#serving-the-model-as-a-container-with-ecr" title="Permalink to this headline">¶</a></h3>
<p>Note that while we are able to write on the output stream, we are only able to write with fixed predictions of <code class="docutils literal notranslate"><span class="pre">10.0</span></code> minutes on a model with version <code class="docutils literal notranslate"><span class="pre">123</span></code>. Now we finally get to the most important part of adding our model. So, again, assume this model is a larger more accurate model that reads on the stream and updates the prediction.</p>
<div class="section" id="function-definition">
<h4>Function definition<a class="headerlink" href="#function-definition" title="Permalink to this headline">¶</a></h4>
<p>We further improve our <code class="docutils literal notranslate"><span class="pre">lambda_function.py</span></code> by including reading environment variables and  downloading the model from S3. The <code class="docutils literal notranslate"><span class="pre">predict</span></code> function now uses the model instead of a constant for returning predictions. Here we convert the output to float instead of a singleton numpy array since the output must be in JSON format. For testing, a <code class="docutils literal notranslate"><span class="pre">TEST_RUN</span></code> flag is defined so that the function can be called without writing on the <code class="docutils literal notranslate"><span class="pre">ride_predictions</span></code> stream.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/7d841f80865c9773a21b2c89c4ffb30fa1c94c2b/docs/notebooks/mlops/04-deployment/streaming/lambda_function.py"><code class="docutils literal notranslate"><span class="pre">lambda_function.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># lambda_function.py</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="kn">from</span> <span class="nn">ride_duration.predict</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">ride_duration.utils</span> <span class="kn">import</span> <span class="n">prepare_features</span>


<span class="c1"># Load environmental variables</span>
<span class="n">PREDICTIONS_STREAM_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PREDICTIONS_STREAM_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;ride_predictions&#39;</span><span class="p">)</span>
<span class="n">TEST_RUN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TEST_RUN&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
<span class="n">RUN_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;RUN_ID&#39;</span><span class="p">)</span>
<span class="n">EXPERIMENT_ID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;EXPERIMENT_ID&#39;</span><span class="p">)</span>

<span class="c1"># Load the model from S3</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">experiment_id</span><span class="o">=</span><span class="n">EXPERIMENT_ID</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">RUN_ID</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    
    <span class="n">prediction_events</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">]:</span>
        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;kinesis&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        
        <span class="n">ride_event</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>
        <span class="n">ride_data</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride&#39;</span><span class="p">]</span>
        <span class="n">ride_id</span> <span class="o">=</span> <span class="n">ride_event</span><span class="p">[</span><span class="s1">&#39;ride_id&#39;</span><span class="p">]</span>
    
        <span class="n">features</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">([</span><span class="n">ride_data</span><span class="p">])</span>
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        
        <span class="n">prediction_event</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;ride_duration_prediction_model&#39;</span><span class="p">,</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">RUN_ID</span><span class="p">,</span>
            <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;ride_duration&#39;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                <span class="s1">&#39;ride_id&#39;</span><span class="p">:</span> <span class="n">ride_id</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">TEST_RUN</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
            <span class="n">kinesis_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;kinesis&#39;</span><span class="p">)</span>

            <span class="c1"># This is just the Python client version of the `aws kinesis put-record` CLI command.</span>
            <span class="c1"># https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/kinesis.html#Kinesis.Client.put_record</span>
            <span class="n">kinesis_client</span><span class="o">.</span><span class="n">put_record</span><span class="p">(</span>
                <span class="n">StreamName</span><span class="o">=</span><span class="n">PREDICTIONS_STREAM_NAME</span><span class="p">,</span>
                <span class="n">Data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">prediction_event</span><span class="p">),</span>
                <span class="n">PartitionKey</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ride_id</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="n">prediction_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction_event</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">prediction_events</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dockerfile">
<h4>Dockerfile<a class="headerlink" href="#dockerfile" title="Permalink to this headline">¶</a></h4>
<p>AWS Lambda provides a <a class="reference external" href="https://gallery.ecr.aws/lambda/python">base image</a> which contain all the required components for running the container on that platform. Note that there is no need to set a working directory and we can work on the root directory.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/7d841f80865c9773a21b2c89c4ffb30fa1c94c2b/docs/notebooks/mlops/04-deployment/streaming/Dockerfile"><code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></a></p>
</div>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span><span class="w"> </span><span class="s">public.ecr.aws/lambda/python:3.9</span>

<span class="k">RUN</span><span class="w"> </span>pip install -U pip
<span class="k">RUN</span><span class="w"> </span>pip install pipenv

<span class="k">COPY</span><span class="w"> </span><span class="o">[</span> <span class="s2">&quot;Pipfile&quot;</span>, <span class="s2">&quot;Pipfile.lock&quot;</span>, <span class="s2">&quot;./&quot;</span> <span class="o">]</span>

<span class="k">RUN</span><span class="w"> </span>pipenv install --system --deploy

<span class="k">COPY</span><span class="w"> </span><span class="o">[</span> <span class="s2">&quot;lambda_function.py&quot;</span>, <span class="s2">&quot;./&quot;</span> <span class="o">]</span>

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;lambda_function.lambda_handler&quot;</span><span class="w"> </span><span class="p">]</span>
</pre></div>
</div>
<p>Building the image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker build -t stream-model-duration:v1 .
</pre></div>
</div>
<p>Running the image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run -it --rm -p <span class="m">8080</span>:8080 --env-file .env stream-model-duration:v1
</pre></div>
</div>
<div class="figure align-default" id="id9">
<a class="reference internal image-reference" href="../../../_images/ecr-img.png"><img alt="../../../_images/ecr-img.png" src="../../../_images/ecr-img.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 27 </span><span class="caption-text">AWS Lambda base image for Python.</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="environmental-variables">
<h4>Environmental variables<a class="headerlink" href="#environmental-variables" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># .env</span>
<span class="nv">TEST_RUN</span><span class="o">=</span>True
<span class="nv">PREDICTIONS_STREAM_NAME</span><span class="o">=</span>ride_predictions
<span class="nv">EXPERIMENT_ID</span><span class="o">=</span><span class="m">1</span>
<span class="nv">RUN_ID</span><span class="o">=</span>f4e2242a53a3410d89c061d1958ae70a
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>*************
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>*************
<span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>us-east-1
</pre></div>
</div>
</div>
<div class="section" id="testing">
<h4>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h4>
<p>AWS Lambda is a cloud service for calling functions. So to check correctness, we simply call <code class="docutils literal notranslate"><span class="pre">lambda_handler(event)</span></code> where the test event is assigned to <code class="docutils literal notranslate"><span class="pre">event</span></code> and examine the output. This is implemented in <a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/e0312f57ce4693f6ffe58bd2dbab4ac95ead08f5/docs/notebooks/mlops/04-deployment/streaming/test.py"><code class="docutils literal notranslate"><span class="pre">test.py</span></code></a> which is executed below. Note that the version is now the MLflow <code class="docutils literal notranslate"><span class="pre">run_id</span></code> and predicted ride duration is different from <code class="docutils literal notranslate"><span class="pre">10.0</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="k">$(</span>cat .env <span class="p">|</span> xargs<span class="k">)</span>
$ python test.py

<span class="o">{</span>
    <span class="s1">&#39;predictions&#39;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s1">&#39;model&#39;</span>: <span class="s1">&#39;ride_duration_prediction_model&#39;</span>, 
            <span class="s1">&#39;version&#39;</span>: <span class="s1">&#39;f4e2242a53a3410d89c061d1958ae70a&#39;</span>, 
            <span class="s1">&#39;prediction&#39;</span>: <span class="o">{</span>
                <span class="s1">&#39;ride_duration&#39;</span>: <span class="m">18</span>.21077067418335, 
                <span class="s1">&#39;ride_id&#39;</span>: <span class="m">123</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Since the function definition looks to be correct, we proceed to testing whether the Docker container is able to run the function. This is implemented in <a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/e0312f57ce4693f6ffe58bd2dbab4ac95ead08f5/docs/notebooks/mlops/04-deployment/streaming/test_docker.py"><code class="docutils literal notranslate"><span class="pre">test_docker.py</span></code></a> that executes a POST request on the following URL:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:8080/2015-03-31/functions/function/invocations&#39;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">functions/function/invocations</span></code> endpoint (v. <code class="docutils literal notranslate"><span class="pre">2015-03-31</span></code>) is exposed by the base image on <code class="docutils literal notranslate"><span class="pre">8080</span></code> which we did not modify. Recall that we had to do port-forwarding when running the container. In AWS Lambda, this endpoint is automatically exposed to records on the input stream, so no further configuration is required on our part. Running the test gives the same result as above.</p>
</div>
<div class="section" id="publishing-to-ecr">
<h4>Publishing to ECR<a class="headerlink" href="#publishing-to-ecr" title="Permalink to this headline">¶</a></h4>
<p>Now that the container is working, we push the container into the registry. First we create a repository for our containers.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><code class="docutils literal notranslate"><span class="pre">aws-cli</span></code> <br>
v. <code class="docutils literal notranslate"><span class="pre">1.22.34</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws ecr create-repository --repository-name duration-model
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;repository&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;repositoryArn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:ecr:us-east-1:241297376613:repository/duration-model&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;registryId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;241297376613&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;repositoryName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;duration-model&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;repositoryUri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;241297376613.dkr.ecr.us-east-1.amazonaws.com/duration-model&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;createdAt&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1656099951.0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;imageTagMutability&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;MUTABLE&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;imageScanningConfiguration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;scanOnPush&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;encryptionConfiguration&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;encryptionType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AES256&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<br><div class="figure align-default" id="id10">
<a class="reference internal image-reference" href="../../../_images/ecr-repo.png"><img alt="../../../_images/ecr-repo.png" src="../../../_images/ecr-repo.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 28 </span><span class="caption-text">The <code class="docutils literal notranslate"><span class="pre">duration-model</span></code> repository in ECR.</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>Logging in:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><code class="docutils literal notranslate"><span class="pre">aws-cli</span></code> <br>
v. <code class="docutils literal notranslate"><span class="pre">1.22.34</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">$(</span>aws ecr get-login --no-include-email<span class="k">)</span>
</pre></div>
</div>
<p>Pushing container to the repository:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span></code> <br>
v. <code class="docutils literal notranslate"><span class="pre">20.10.12</span></code></p>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">REMOTE_URI</span><span class="o">=</span><span class="m">241297376613</span>.dkr.ecr.us-east-1.amazonaws.com/duration-model
<span class="nv">REMOTE_TAG</span><span class="o">=</span>v1
<span class="nv">REMOTE_IMAGE_URI</span><span class="o">=</span><span class="si">${</span><span class="nv">REMOTE_URI</span><span class="si">}</span>:<span class="si">${</span><span class="nv">REMOTE_TAG</span><span class="si">}</span>
<span class="nv">LOCAL_IMAGE</span><span class="o">=</span>stream-model-duration:v1

docker tag <span class="si">${</span><span class="nv">LOCAL_IMAGE</span><span class="si">}</span> <span class="si">${</span><span class="nv">REMOTE_IMAGE_URI</span><span class="si">}</span>
docker push <span class="si">${</span><span class="nv">REMOTE_IMAGE_URI</span><span class="si">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>The push refers to repository <span class="o">[</span><span class="m">241297376613</span>.dkr.ecr.us-east-1.amazonaws.com/duration-model<span class="o">]</span>
d633cfbf6042: Pushed
1e16d3c3a5e4: Pushing  <span class="m">124</span>.5MB/657MB
593e5b91fe04: Pushed
ed5e98d9c477: Pushed
a5a2488932a6: Pushed
8071867dc313: Pushed
39978c3cb375: Pushing  <span class="m">223</span>.5MB
6ea38db36806: Pushed
f92fb29958b6: Pushed
f1c31f6b2603: Pushed
fe1bfb0e592a: Pushing  <span class="m">115</span>.7MB/333.9MB
</pre></div>
</div>
<br><div class="figure align-default" id="id11">
<a class="reference internal image-reference" href="../../../_images/ecr-repo-v1.png"><img alt="../../../_images/ecr-repo-v1.png" src="../../../_images/ecr-repo-v1.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 29 </span><span class="caption-text">The <code class="docutils literal notranslate"><span class="pre">v1</span></code> container has been pushed to the <code class="docutils literal notranslate"><span class="pre">duration-model</span></code> repository in ECR.</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="creating-the-lambda-function">
<h4>Creating the lambda function<a class="headerlink" href="#creating-the-lambda-function" title="Permalink to this headline">¶</a></h4>
<p>Now that we have our container in ECR, we deploy this in AWS Lambda. Then, we attach the <code class="docutils literal notranslate"><span class="pre">ride_events</span></code> stream as input or trigger, and update its environmental variables. Recall that we run our container with a <code class="docutils literal notranslate"><span class="pre">.env</span></code> file during testing. We also have to update the memory allocated to the function and its allocated prediction time.</p>
<div class="figure align-default" id="id12">
<a class="reference internal image-reference" href="../../../_images/ecr-create-function.png"><img alt="../../../_images/ecr-create-function.png" src="../../../_images/ecr-create-function.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 30 </span><span class="caption-text">Creating a Lambda function based on a container. Here we need the remote image URI which we copied using the <strong>Copy URI</strong> button in the <code class="docutils literal notranslate"><span class="pre">v1</span></code> image in ECR.</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id13">
<a class="reference internal image-reference" href="../../../_images/ecr-memory-settings.png"><img alt="../../../_images/ecr-memory-settings.png" src="../../../_images/ecr-memory-settings.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 31 </span><span class="caption-text">Update memory to 512 MB and timeout to 15 seconds.</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id14">
<a class="reference internal image-reference" href="../../../_images/ecr-env-variables.png"><img alt="../../../_images/ecr-env-variables.png" src="../../../_images/ecr-env-variables.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 32 </span><span class="caption-text">Assigning environmental variables. Here we just transfer our <code class="docutils literal notranslate"><span class="pre">.env</span></code> files.</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
<p>Configure the test in the UI with the above test event<a class="footnote-reference brackets" href="#ref" id="id1">1</a> and execute test. Here we are testing for permission and execution time and memory. Notice that the first call takes a while, but subsequent tests are faster. This is why we initially set timeout to 15 seconds. Further tests only require 0.1 seconds.</p>
<div class="figure align-default" id="id15">
<a class="reference internal image-reference" href="../../../_images/ecr-test-results.png"><img alt="../../../_images/ecr-test-results.png" src="../../../_images/ecr-test-results.png" style="width: 40em;" /></a>
<p class="caption"><span class="caption-number">Fig. 33 </span><span class="caption-text">Execution results for testing in the UI.</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</div>
<br><p>Further tests by modifying <code class="docutils literal notranslate"><span class="pre">ride_id</span></code> for better visibility. Here we will try to retrieve the results from the output stream. Putting an event on input stream:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>aws kinesis put-record <span class="se">\</span>
    --stream-name ride_events <span class="se">\</span>
    --partition-key <span class="m">1</span> <span class="se">\</span>
    --data <span class="s1">&#39;{</span>
<span class="s1">        &quot;ride&quot;: {</span>
<span class="s1">            &quot;PULocationID&quot;: 130,</span>
<span class="s1">            &quot;DOLocationID&quot;: 205,</span>
<span class="s1">            &quot;trip_distance&quot;: 3.66</span>
<span class="s1">        },</span>
<span class="s1">        &quot;ride_id&quot;: &quot;container_test_event&quot;</span>
<span class="s1">    }&#39;</span>
</pre></div>
</div>
<p>Fetching test results from output stream:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">KINESIS_STREAM_OUTPUT</span><span class="o">=</span><span class="s1">&#39;ride_predictions&#39;</span>
<span class="nv">SHARD</span><span class="o">=</span><span class="s1">&#39;shardId-000000000000&#39;</span>

<span class="nv">SHARD_ITERATOR</span><span class="o">=</span><span class="k">$(</span>aws kinesis <span class="se">\</span>
    get-shard-iterator <span class="se">\</span>
        --shard-id <span class="si">${</span><span class="nv">SHARD</span><span class="si">}</span> <span class="se">\</span>
        --shard-iterator-type TRIM_HORIZON <span class="se">\</span>
        --stream-name <span class="si">${</span><span class="nv">KINESIS_STREAM_OUTPUT</span><span class="si">}</span> <span class="se">\</span>
        --query <span class="s1">&#39;ShardIterator&#39;</span> <span class="se">\</span>
<span class="k">)</span>

<span class="nv">RESULT</span><span class="o">=</span><span class="k">$(</span>aws kinesis get-records --shard-iterator <span class="nv">$SHARD_ITERATOR</span><span class="k">)</span>
$ <span class="nb">echo</span> <span class="si">${</span><span class="nv">RESULT</span><span class="si">}</span> <span class="p">|</span> jq -r <span class="s1">&#39;.Records[-1].Data&#39;</span> <span class="p">|</span> base64 --decode <span class="p">|</span> jq
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>{
  &quot;model&quot;: &quot;ride_duration_prediction_model&quot;,
  &quot;version&quot;: &quot;f4e2242a53a3410d89c061d1958ae70a&quot;,
  &quot;prediction&quot;: {
    &quot;ride_duration&quot;: 18.210770674183355,
    &quot;ride_id&quot;: &quot;container_test_event&quot;
  }
}
</pre></div>
</div>
<p>It looks like the output is from our container. Nice!</p>
<p><strong>Remark.</strong> The obtained records can be from the test lambda function which also reads and writes on the same data streams as the container. Either delete that or wait for a few seconds and execute <code class="docutils literal notranslate"><span class="pre">get-records</span></code> again to get the expected output. This also demonstrates how we can have multiple lambda functions acting on the same stream.</p>
</div>
</div>
</div>
<div class="section" id="deploying-batch-predictions">
<h2>Deploying batch predictions<a class="headerlink" href="#deploying-batch-predictions" title="Permalink to this headline">¶</a></h2>
<p>For use cases that do not require the responsiveness of a web service, we can implement an offline service that makes batch predictions. Typically, offline services are expected to be done between fixed time periods, e.g. daily, weekly, or monthly. A critical element of this is <strong>workflow orchestration</strong>. In our example, we screate a workflow where we regularly pull data from a database, make predictions on that data, then write the predictions file on S3. This file can be used for analytics or for powering a chart in a dashboard.</p>
<div class="section" id="batch-scoring">
<h3>Batch scoring<a class="headerlink" href="#batch-scoring" title="Permalink to this headline">¶</a></h3>
<p>For batch scoring we simply load the model and use it to make batch predictions on a list of examples. After prediction, we format our output file. This includes all information relevant to modelling that can be useful for analytics and monitoring. A generated <code class="docutils literal notranslate"><span class="pre">uuid</span></code> for each row that acts as an index and the <code class="docutils literal notranslate"><span class="pre">run_id</span></code> of the model are included for observability.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/8189857b1559d11121bb23630e223eff3b054ff5/docs/notebooks/mlops/04-deployment/score.py"><code class="docutils literal notranslate"><span class="pre">score.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">save_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save output dataframe containing model predictions.&quot;&quot;&quot;</span>

    <span class="n">results_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;lpep_pickup_datetime&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;PULocationID&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;DOLocationID&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span> 
    <span class="p">]</span>
    
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">results_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;actual_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;predicted_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preds</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;actual_duration&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;predicted_duration&#39;</span><span class="p">]</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;model_version&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">run_id</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;ride_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))]</span>
    
    <span class="c1"># Saving results</span>
    <span class="n">df_results</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="o">...</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">apply_model</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">experiment_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load input and model. Make predictions on the input file.&quot;&quot;&quot;</span>
    
    <span class="c1"># Get prefect logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_run_logger</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading the data from </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">load_training_dataframe</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span> <span class="c1"># load from S3</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading model </span><span class="si">{</span><span class="n">experiment_id</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Applying the model&#39;</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">make_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving the result to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">save_results</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
</pre></div>
</div>
<p>One thing that can be easily missed here is that <code class="docutils literal notranslate"><span class="pre">df_results.to_parquet(output_file)</span></code> actually writes directly to S3 whenever <code class="docutils literal notranslate"><span class="pre">output_file</span></code> has the form <code class="docutils literal notranslate"><span class="pre">&quot;s3://bucket/file_path&quot;</span></code>. In fact, this will be how we will save our output files to our S3 bucket. Let us look at an example of applying the model for February 2021:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">prefect</span> <span class="kn">import</span> <span class="n">flow</span>
<span class="kn">from</span> <span class="nn">score</span> <span class="kn">import</span> <span class="n">apply_model</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span> 

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">test_apply_model</span><span class="p">():</span>
    <span class="n">apply_model</span><span class="p">(</span>
        <span class="n">input_file</span><span class="o">=</span><span class="s1">&#39;s3://nyc-tlc/trip data/green_tripdata_2021-02.parquet&#39;</span><span class="p">,</span> 
        <span class="n">output_file</span><span class="o">=</span><span class="s1">&#39;batch_score.parquet&#39;</span><span class="p">,</span> 
        <span class="n">experiment_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXPERIMENT_ID&quot;</span><span class="p">),</span> 
        <span class="n">run_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RUN_ID&quot;</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">test_apply_model</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>09:38:19.628 | INFO    | prefect.engine - Created flow run &#39;shrewd-gerbil&#39; for flow &#39;test-apply-model&#39;
09:38:19.629 | INFO    | Flow run &#39;shrewd-gerbil&#39; - Using task runner &#39;ConcurrentTaskRunner&#39;
09:38:19.634 | WARNING | Flow run &#39;shrewd-gerbil&#39; - No default storage is configured on the server. Results from this flow run will be stored in a temporary directory in its runtime environment.
09:38:19.661 | INFO    | Flow run &#39;shrewd-gerbil&#39; - Created task run &#39;apply_model-665e7535-0&#39; for task &#39;apply_model&#39;
09:38:19.675 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Reading the data from s3://nyc-tlc/trip data/green_tripdata_2021-02.parquet
09:38:29.733 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Loading model 1/f4e2242a53a3410d89c061d1958ae70a
09:38:48.426 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Applying the model
09:38:48.816 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Saving the result to batch_score.parquet
09:38:49.135 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Finished in state Completed()
09:38:49.145 | INFO    | Flow run &#39;shrewd-gerbil&#39; - Finished in state Completed(&#39;All states completed.&#39;)
Completed(message=&#39;All states completed.&#39;, type=COMPLETED, result=[Completed(message=None, type=COMPLETED, result=None, task_run_id=27a60261-d23f-435f-b854-d7afacc58fc6)], flow_run_id=83e80f7c-1d8a-4bf3-9453-60dd40bd555b)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;batch_score.parquet&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lpep_pickup_datetime</th>
      <th>PULocationID</th>
      <th>DOLocationID</th>
      <th>trip_distance</th>
      <th>actual_duration</th>
      <th>predicted_duration</th>
      <th>diff</th>
      <th>model_version</th>
      <th>ride_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2021-02-01 00:34:03</td>
      <td>130</td>
      <td>205</td>
      <td>3.66</td>
      <td>17.916667</td>
      <td>18.210771</td>
      <td>-0.294104</td>
      <td>f4e2242a53a3410d89c061d1958ae70a</td>
      <td>93bfe84a-800f-4ec7-b9e1-0966e1c57f21</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-02-01 00:04:00</td>
      <td>152</td>
      <td>244</td>
      <td>1.10</td>
      <td>6.500000</td>
      <td>7.010569</td>
      <td>-0.510569</td>
      <td>f4e2242a53a3410d89c061d1958ae70a</td>
      <td>b4cf270f-8324-4afe-98f8-69a3017d7c4b</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-02-01 00:18:51</td>
      <td>152</td>
      <td>48</td>
      <td>4.93</td>
      <td>15.250000</td>
      <td>21.430337</td>
      <td>-6.180337</td>
      <td>f4e2242a53a3410d89c061d1958ae70a</td>
      <td>b93afee8-bac2-4c80-83c0-289bc4aa7fa4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-02-01 00:53:27</td>
      <td>152</td>
      <td>241</td>
      <td>6.70</td>
      <td>18.233333</td>
      <td>24.683903</td>
      <td>-6.450570</td>
      <td>f4e2242a53a3410d89c061d1958ae70a</td>
      <td>f7621d8f-394d-4ffd-923f-b30e6195f608</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-02-01 00:57:46</td>
      <td>75</td>
      <td>42</td>
      <td>1.89</td>
      <td>8.966667</td>
      <td>10.630539</td>
      <td>-1.663872</td>
      <td>f4e2242a53a3410d89c061d1958ae70a</td>
      <td>44734c3d-9f44-46be-86bd-254afd4bdb07</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span>  <span class="c1"># rmse</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.713046656895089
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prefect-flow-for-batch-scoring">
<h3>Prefect flow for batch scoring<a class="headerlink" href="#prefect-flow-for-batch-scoring" title="Permalink to this headline">¶</a></h3>
<p>In this section, we create the <code class="docutils literal notranslate"><span class="pre">flow</span></code> for batch scoring the data from the previous month relative to its scheduled run date. This will be deployed to run monthly for batch scoring rides that occured during the previous month.</p>
<p>For example, if a <code class="docutils literal notranslate"><span class="pre">flow</span></code> is scheduled on <code class="docutils literal notranslate"><span class="pre">2021/06/02</span></code>, then batch scoring is performed on taxi data gathered on May 2021. The link to the correct file in S3 is returned by the <code class="docutils literal notranslate"><span class="pre">get_paths</span></code> function. Note that the files are already nicely aggregated by month and can be downloaded without worrying about credentials. For the output file, we simply separate outputs using different folders for each parameter value.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/356f05bc25702efe41d80d4158f5b33864ae14a3/docs/notebooks/mlops/04-deployment/score.py#L41-L62"><code class="docutils literal notranslate"><span class="pre">score.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_paths</span><span class="p">(</span><span class="n">run_date</span><span class="p">,</span> <span class="n">taxi_type</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get input and output file paths from scheduled date.&quot;&quot;&quot;</span>

    <span class="c1"># Get previous month and year from run date</span>
    <span class="c1"># e.g. run date=2021/06/02 -&gt; month=5, year=2021 (input).</span>
    <span class="n">prev_month</span> <span class="o">=</span> <span class="n">run_date</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">prev_month</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">prev_month</span><span class="o">.</span><span class="n">month</span> 

    <span class="n">input_file</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;s3://nyc-tlc/trip data/&#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">taxi_type</span><span class="si">}</span><span class="s1">_tripdata_&#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">year</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">.parquet&#39;</span>
    <span class="p">)</span>
    
    <span class="n">output_file</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;s3://nyc-duration-prediction-ron/&#39;</span> 
        <span class="sa">f</span><span class="s1">&#39;taxi_type=</span><span class="si">{</span><span class="n">taxi_type</span><span class="si">}</span><span class="s1">/&#39;</span>
        <span class="sa">f</span><span class="s1">&#39;year=</span><span class="si">{</span><span class="n">year</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">/month=</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">{</span><span class="n">run_id</span><span class="p">}</span><span class="o">.</span><span class="n">parquet</span><span class="s1">&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span>
</pre></div>
</div>
<p>Finally, we define the <code class="docutils literal notranslate"><span class="pre">ride_duration_prediction</span></code> flow. From the <code class="docutils literal notranslate"><span class="pre">get_paths</span></code> function, we know that this flow applies the model on data collected over the previous month relative to the <code class="docutils literal notranslate"><span class="pre">run_date</span></code>. Below on our deployment specification, we leave out <code class="docutils literal notranslate"><span class="pre">run_date</span></code> so that it evaluates to <code class="docutils literal notranslate"><span class="pre">ctx.flow_run.expected_start_time</span></code> which fetches the scheduled run date of the flow.</p>
<p><strong>Remark.</strong> Getting scheduled run date makes sense because this delegates the responsibility of getting the correct date to the orchestrator instead of the executing machine, e.g. using <code class="docutils literal notranslate"><span class="pre">datetime</span></code> as the system clocks may be rogue or be in a different timezone, or these workflows can be delayed, resulting in output files containing predictions on wrong dates.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/356f05bc25702efe41d80d4158f5b33864ae14a3/docs/notebooks/mlops/04-deployment/score.py#L85-L128"><code class="docutils literal notranslate"><span class="pre">score.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">ride_duration_prediction</span><span class="p">(</span>
        <span class="n">taxi_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">run_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="c1"># Get scheduled data if no run_date</span>
    <span class="k">if</span> <span class="n">run_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_run_context</span><span class="p">()</span>
        <span class="n">run_date</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">flow_run</span><span class="o">.</span><span class="n">expected_start_time</span>
    
    <span class="c1"># Get input path and output path in S3</span>
    <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">get_paths</span><span class="p">(</span><span class="n">run_date</span><span class="p">,</span> <span class="n">taxi_type</span><span class="p">,</span> <span class="n">run_id</span><span class="p">)</span>

    <span class="c1"># Execute make predictions on input task</span>
    <span class="n">apply_model</span><span class="p">(</span>
        <span class="n">input_file</span><span class="o">=</span><span class="n">input_file</span><span class="p">,</span>
        <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Run flow</span>
    <span class="n">ride_duration_prediction</span><span class="p">(</span>
        <span class="n">taxi_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">taxi_type</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">experiment_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
        <span class="n">run_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>

</pre></div>
</div>
<p>Running one flow on the command line:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python score.py \
    --taxi-type green \
    --run-id f4e2242a53a3410d89c061d1958ae70a \
    --experiment-id 1 \
    --year 2021 \
    --month 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12:07:39.115 | INFO    | prefect.engine - Created flow run &#39;piquant-jacamar&#39; for flow &#39;ride-duration-prediction&#39;
12:07:39.115 | INFO    | Flow run &#39;piquant-jacamar&#39; - Using task runner &#39;ConcurrentTaskRunner&#39;
12:07:39.120 | WARNING | Flow run &#39;piquant-jacamar&#39; - No default storage is configured on the server. Results from this flow run will be stored in a temporary directory in its runtime environment.
12:07:39.144 | INFO    | Flow run &#39;piquant-jacamar&#39; - Created task run &#39;apply_model-b21fdc82-0&#39; for task &#39;apply_model&#39;
12:07:39.157 | INFO    | Task run &#39;apply_model-b21fdc82-0&#39; - Reading the data from s3://nyc-tlc/trip data/green_tripdata_2021-01.parquet
12:07:48.615 | INFO    | Task run &#39;apply_model-b21fdc82-0&#39; - Loading model 1/f4e2242a53a3410d89c061d1958ae70a
12:08:08.153 | INFO    | Task run &#39;apply_model-b21fdc82-0&#39; - Applying the model
12:08:08.463 | INFO    | Task run &#39;apply_model-b21fdc82-0&#39; - Saving the result to s3://nyc-duration-prediction-ron/taxi_type=green/year=2021/month=01/f4e2242a53a3410d89c061d1958ae70a.parquet
12:08:19.979 | INFO    | Task run &#39;apply_model-b21fdc82-0&#39; - Finished in state Completed()
12:08:19.987 | INFO    | Flow run &#39;piquant-jacamar&#39; - Finished in state Completed(&#39;All states completed.&#39;)
</pre></div>
</div>
</div>
</div>
<br><div class="figure align-default" id="id16">
<img alt="../../../_images/prefect_scoring.png" src="../../../_images/prefect_scoring.png" />
<p class="caption"><span class="caption-number">Fig. 34 </span><span class="caption-text">Prefect UI for a run of our batch scoring flow <code class="docutils literal notranslate"><span class="pre">ride_duration_prediction</span></code> with <code class="docutils literal notranslate"><span class="pre">run_date</span></code> set to Feb 2, 2021. This consists of a single task.</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id17">
<img alt="../../../_images/output-s3.png" src="../../../_images/output-s3.png" />
<p class="caption"><span class="caption-number">Fig. 35 </span><span class="caption-text">The resulting output file in S3 for a flow with <code class="docutils literal notranslate"><span class="pre">run_date</span></code> set to Feb 2, 2021.</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="deploying-the-batch-scoring-workflow-in-prefect">
<h3>Deploying the batch scoring workflow in Prefect<a class="headerlink" href="#deploying-the-batch-scoring-workflow-in-prefect" title="Permalink to this headline">¶</a></h3>
<p>First create local storage in the terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ prefect storage create
...
Registered storage <span class="s1">&#39;localstorage&#39;</span> with identifier <span class="s1">&#39;4c53e1c9-e8dc-4325-8832-2802e1778654&#39;</span>.
</pre></div>
</div>
<p>Create the following deployment specification:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/1b235cd046e6413be7a3b1701696e15399bd26bc/docs/notebooks/mlops/04-deployment/score_deploy.py"><code class="docutils literal notranslate"><span class="pre">score_deploy.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">prefect.deployments</span> <span class="kn">import</span> <span class="n">DeploymentSpec</span>
<span class="kn">from</span> <span class="nn">prefect.orion.schemas.schedules</span> <span class="kn">import</span> <span class="n">CronSchedule</span>
<span class="kn">from</span> <span class="nn">prefect.flow_runners</span> <span class="kn">import</span> <span class="n">SubprocessFlowRunner</span>


<span class="n">DeploymentSpec</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;monthly&quot;</span><span class="p">,</span>
    <span class="n">flow_location</span><span class="o">=</span><span class="s2">&quot;./score.py&quot;</span><span class="p">,</span>
    <span class="n">flow_name</span><span class="o">=</span><span class="s2">&quot;ride-duration-prediction&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;taxi_type&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="s2">&quot;f4e2242a53a3410d89c061d1958ae70a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">flow_storage</span><span class="o">=</span><span class="s2">&quot;4c53e1c9-e8dc-4325-8832-2802e1778654&quot;</span><span class="p">,</span>
    <span class="n">schedule</span><span class="o">=</span><span class="n">CronSchedule</span><span class="p">(</span><span class="n">cron</span><span class="o">=</span><span class="s2">&quot;0 3 2 * *&quot;</span><span class="p">),</span> <span class="c1"># https://crontab.guru/#0_3_2_*_*</span>
    <span class="n">flow_runner</span><span class="o">=</span><span class="n">SubprocessFlowRunner</span><span class="p">(),</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ml&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Deploying:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>prefect deployment create score_deploy.py
<span class="o">!</span>prefect deployment ls
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading deployment specifications from python script at <span class=" -Color -Color-Green">&#39;score_deploy.py&#39;</span>...
/Users/particle1331/miniforge3/envs/prefect/lib/python3.9/site-packages/prefect/deployments.py:247: UserWarning: You have configured local storage, this deployment will only be usable from the current machine..
  warnings.warn(
Creating deployment <span class=" -Color -Color-Bold -Color-Bold-Blue">&#39;monthly&#39;</span> for flow <span class=" -Color -Color-Blue">&#39;ride-duration-prediction&#39;</span>...
Deploying flow script from <span class=" -Color -Color-Green">&#39;/Users/particle1331/code/inefficient-networks/docs/n</span>
<span class=" -Color -Color-Green">otebooks/mlops/04-deployment/score.py&#39;</span> using Local Storage...
Created deployment <span class=" -Color -Color-Blue">&#39;ride-duration-prediction/</span><span class=" -Color -Color-Bold -Color-Bold-Blue">monthly&#39;</span>.
View your new deployment with: 

    prefect deployment inspect <span class=" -Color -Color-Blue">&#39;ride-duration-prediction/</span><span class=" -Color -Color-Bold -Color-Bold-Blue">monthly&#39;</span>
<span class=" -Color -Color-Green">Created 1 deployments!</span>
                                Deployments                                
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span class=" -Color -Color-Bold"> Name                             </span>┃<span class=" -Color -Color-Bold"> ID                                   </span>┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span class=" -Color -Color-Blue"> ride-duration-prediction/</span><span class=" -Color -Color-Bold -Color-Bold-Blue">monthly</span><span class=" -Color -Color-Blue"> </span>│<span class=" -Color -Color-Cyan"> d20eb66c-6ddd-4045-b99f-a5f927f4f6ad </span>│
└──────────────────────────────────┴──────────────────────────────────────┘
</pre></div>
</div>
</div>
</div>
<p>Creating work queue:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!prefect work-queue create \
    --deployment d20eb66c-6ddd-4045-b99f-a5f927f4f6ad \
    --flow-runner subprocess ride-duration-prediction-monthly
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Magenta">UUID</span><span class=" -Color -Color-Bold">(</span><span class=" -Color -Color-Green">&#39;f60594a4-1879-47a5-8fdf-cc59f7a3f2f2&#39;</span><span class=" -Color -Color-Bold">)</span>
</pre></div>
</div>
</div>
</div>
<p>Checking runs for the next three months:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>prefect work-queue preview f60594a4-1879-47a5-8fdf-cc59f7a3f2f2 --hours <span class="k">$((</span> <span class="m">24</span> <span class="o">*</span> <span class="m">90</span> <span class="k">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>┏━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃<span class=" -Color -Color-Bold"> Scheduled St… </span>┃<span class=" -Color -Color-Bold"> Run ID                   </span>┃<span class=" -Color -Color-Bold"> Name  </span>┃<span class=" -Color -Color-Bold"> Deployment ID             </span>┃
┡━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│<span class=" -Color -Color-Yellow"> 2022-09-02 0… </span>│<span class=" -Color -Color-Cyan"> 5850a16a-a6d6-4beb-9b8b… </span>│<span class=" -Color -Color-Green"> dang… </span>│<span class=" -Color -Color-Blue"> d20eb66c-6ddd-4045-b99f-… </span>│
│<span class=" -Color -Color-Yellow"> 2022-08-02 0… </span>│<span class=" -Color -Color-Cyan"> 3dfd963d-dbff-46c4-bfcc… </span>│<span class=" -Color -Color-Green"> nost… </span>│<span class=" -Color -Color-Blue"> d20eb66c-6ddd-4045-b99f-… </span>│
│<span class=" -Color -Color-Yellow"> 2022-07-02 0… </span>│<span class=" -Color -Color-Cyan"> 19c24867-851a-4adc-98d7… </span>│<span class=" -Color -Color-Green"> grac… </span>│<span class=" -Color -Color-Blue"> d20eb66c-6ddd-4045-b99f-… </span>│
└───────────────┴──────────────────────────┴───────┴───────────────────────────┘
<span class=" -Color -Color-Red">                            (**) denotes a late run                             </span>
</pre></div>
</div>
</div>
</div>
<p>Starting the work-queue:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>prefect agent start f60594a4-1879-47a5-8fdf-cc59f7a3f2f2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting agent with ephemeral API...

  ___ ___ ___ ___ ___ ___ _____     _   ___ ___ _  _ _____
 | _ \ _ \ __| __| __/ __|_   _|   /_\ / __| __| \| |_   _|
 |  _/   / _|| _|| _| (__  | |    / _ \ (_ | _|| .` | | |
 |_| |_|_\___|_| |___\___| |_|   /_/ \_\___|___|_|\_| |_|


Agent started! Looking for work from queue 
&#39;f60594a4-1879-47a5-8fdf-cc59f7a3f2f2&#39;...
^C

Aborted!
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="id18">
<img alt="../../../_images/prefect-schedule.png" src="../../../_images/prefect-schedule.png" />
<p class="caption"><span class="caption-number">Fig. 36 </span><span class="caption-text">Deployed workflows.</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="backfilling-or-predicting-on-previous-dates">
<h3>Backfilling or predicting on previous dates<a class="headerlink" href="#backfilling-or-predicting-on-previous-dates" title="Permalink to this headline">¶</a></h3>
<p>The idea of the is to execute batch prediction subflows for months in the past using the current model. In the following flow, we simply execute the <code class="docutils literal notranslate"><span class="pre">ride_duration_prediction</span></code> flow with <code class="docutils literal notranslate"><span class="pre">run_date</span></code> for each month from <code class="docutils literal notranslate"><span class="pre">start_date</span></code> up to <code class="docutils literal notranslate"><span class="pre">end_date</span></code>.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/caa2c81cd130ff8c027e31baeee8c4b56f8e88f2/docs/notebooks/mlops/04-deployment/score_backfill.py#L9-L56"><code class="docutils literal notranslate"><span class="pre">score_backfill.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@flow</span>
<span class="k">def</span> <span class="nf">ride_duration_prediction_backfill</span><span class="p">(</span>
    <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">experiment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">taxi_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> 
    <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run batch scoring flows for run dates </span>
<span class="sd">    between start_date and end_date (inclusive).&quot;&quot;&quot;</span>

    <span class="n">run_date</span> <span class="o">=</span> <span class="n">start_date</span>

    <span class="k">while</span> <span class="n">run_date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">:</span>

        <span class="n">score</span><span class="o">.</span><span class="n">ride_duration_prediction</span><span class="p">(</span>
            <span class="n">taxi_type</span><span class="o">=</span><span class="n">taxi_type</span><span class="p">,</span>
            <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">run_date</span><span class="o">=</span><span class="n">run_date</span>
        <span class="p">)</span>
        
        <span class="n">run_date</span> <span class="o">=</span> <span class="n">run_date</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">start_year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">start_month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">end_year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">end_month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ride_duration_prediction_backfill</span><span class="p">(</span>
        <span class="n">experiment_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">taxi_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">taxi_type</span><span class="p">,</span>
        <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> 
        <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Running predictions on months December 2020 to March 2022:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!python score_backfill.py \
    --taxi-type green \
    --experiment-id 1 \
    --run-id f4e2242a53a3410d89c061d1958ae70a \
    --start-month 1 \
    --start-year 2021 \
    --end-month 4 \
    --end-year 2022 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13:11:32.073 | INFO    | prefect.engine - Created flow run &#39;daffodil-bonobo&#39; for flow &#39;ride-duration-prediction-backfill&#39;
13:11:32.073 | INFO    | Flow run &#39;daffodil-bonobo&#39; - Using task runner &#39;ConcurrentTaskRunner&#39;
13:11:32.078 | WARNING | Flow run &#39;daffodil-bonobo&#39; - No default storage is configured on the server. Results from this flow run will be stored in a temporary directory in its runtime environment.
13:11:32.119 | INFO    | Flow run &#39;daffodil-bonobo&#39; - Created subflow run &#39;chocolate-butterfly&#39; for flow &#39;ride-duration-prediction&#39;
13:11:32.142 | INFO    | Flow run &#39;chocolate-butterfly&#39; - Created task run &#39;apply_model-665e7535-0&#39; for task &#39;apply_model&#39;
13:11:32.155 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Reading the data from s3://nyc-tlc/trip data/green_tripdata_2020-12.parquet
13:11:45.139 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Loading model 1/f4e2242a53a3410d89c061d1958ae70a
13:14:20.314 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Applying the model
13:14:20.642 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Saving the result to s3://nyc-duration-prediction-ron/taxi_type=green/year=2020/month=12/f4e2242a53a3410d89c061d1958ae70a.parquet
13:14:35.829 | INFO    | Task run &#39;apply_model-665e7535-0&#39; - Finished in state Completed()
13:14:35.843 | INFO    | Flow run &#39;chocolate-butterfly&#39; - Finished in state Completed(&#39;All states completed.&#39;)
13:14:35.872 | INFO    | Flow run &#39;daffodil-bonobo&#39; - Created subflow run &#39;esoteric-caterpillar&#39; for flow &#39;ride-duration-prediction&#39;
13:14:35.895 | INFO    | Flow run &#39;esoteric-caterpillar&#39; - Created task run &#39;apply_model-665e7535-1&#39; for task &#39;apply_model&#39;
13:14:35.905 | INFO    | Task run &#39;apply_model-665e7535-1&#39; - Reading the data from s3://nyc-tlc/trip data/green_tripdata_2021-01.parquet
13:14:44.977 | INFO    | Task run &#39;apply_model-665e7535-1&#39; - Loading model 1/f4e2242a53a3410d89c061d1958ae70a
13:16:15.032 | INFO    | Task run &#39;apply_model-665e7535-1&#39; - Applying the model
13:16:15.383 | INFO    | Task run &#39;apply_model-665e7535-1&#39; - Saving the result to s3://nyc-duration-prediction-ron/taxi_type=green/year=2021/month=01/f4e2242a53a3410d89c061d1958ae70a.parquet
13:16:27.319 | INFO    | Task run &#39;apply_model-665e7535-1&#39; - Finished in state Completed()
13:16:27.331 | INFO    | Flow run &#39;esoteric-caterpillar&#39; - Finished in state Completed(&#39;All states completed.&#39;)
...
</pre></div>
</div>
</div>
</div>
<div class="figure align-default" id="id19">
<img alt="../../../_images/prefect-backfill.png" src="../../../_images/prefect-backfill.png" />
<p class="caption"><span class="caption-number">Fig. 37 </span><span class="caption-text">Running batch prediction tasks for 16 months.</span><a class="headerlink" href="#id19" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="id20">
<img alt="../../../_images/batch-s3.png" src="../../../_images/batch-s3.png" />
<p class="caption"><span class="caption-number">Fig. 38 </span><span class="caption-text">Output files for 16 months of batch predictions.</span><a class="headerlink" href="#id20" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="appendix-model-train-script">
<h2>Appendix: Model train script<a class="headerlink" href="#appendix-model-train-script" title="Permalink to this headline">¶</a></h2>
<p>For training models that we use to serve predictions in our API, we use the following script. This trains a model using the <code class="docutils literal notranslate"><span class="pre">ride_duration</span></code> package (which ensures smooth integration with the Flask API) and logs the trained model to a remote MLflow tracking server. The tracking server host is provided as a command line argument.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://github.com/particle1331/inefficient-networks/blob/217134c84bb323452bf0dc3e8b6a6a04fea8f06b/docs/notebooks/mlops/04-deployment/train.py"><code class="docutils literal notranslate"><span class="pre">train.py</span></code></a></p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span> 
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">DictVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>

<span class="kn">from</span> <span class="nn">ride_duration.utils</span> <span class="kn">import</span> <span class="n">load_training_dataframe</span><span class="p">,</span> <span class="n">prepare_features</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">tracking_server_host</span><span class="p">):</span>
    <span class="n">TRACKING_URI</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">tracking_server_host</span><span class="si">}</span><span class="s2">:5000&quot;</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">TRACKING_URI</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;nyc-taxi-experiment&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_training</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">20</span>
        <span class="p">}</span>
        
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
            <span class="n">DictVectorizer</span><span class="p">(),</span> 
            <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;rmse_valid&quot;</span><span class="p">,</span> <span class="n">rmse</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">argparse</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--tracking-server-host&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--train-path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--valid-path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Getting data from disk</span>
    <span class="n">train_data</span> <span class="o">=</span> <span class="n">load_training_dataframe</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">train_path</span><span class="p">)</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">load_training_dataframe</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">valid_path</span><span class="p">)</span>

    <span class="c1"># Preprocessing dataset</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">X_valid</span> <span class="o">=</span> <span class="n">prepare_features</span><span class="p">(</span><span class="n">valid_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_valid</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Push training to server</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tracking_server_host</span><span class="p">)</span>
    <span class="n">run_training</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
</pre></div>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="ref"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Press CTRL+F <strong>Actual test event</strong> to find the code cell where this is defined.</p>
</dd>
</dl>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/mlops/04-deployment"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../03-prefect/notes.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Orchestration and ML Pipelines</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../05-monitoring/notes.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Model Monitoring</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By 𝗥𝗼𝗻 𝗠𝗲𝗱𝗶𝗻𝗮. Powered by <a href="https://jupyterbook.org">Jupyter Book</a>.<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>